<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - Find Your Perfect Space</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .room-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .room-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        #chatbotPopup {
            transition: transform 0.3s ease-in-out;
        }
        #chatbotPopup.hidden {
            transform: translateY(100%);
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="index.html" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="sublease.html" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="ai-negotiator.html" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section id="home" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white py-20 text-center">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-4">Find Your Perfect Room</h1>
            <p class="text-lg sm:text-xl mb-6">Effortlessly browse and save rooms tailored to your needs with Room Finder.</p>
        </div>
    </section>

    <!-- Main Content -->
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Room Input Form -->
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Add a Room</h2>
            <div class="space-y-6">
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="location" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., Seattle, WA" required>
                </div>
                <div>
                    <label for="roomType" class="block text-sm font-medium text-gray-700">Room Type</label>
                    <select id="roomType" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                        <option value="" disabled selected>Select a room type</option>
                        <option value="House">House</option>
                        <option value="Apartment">Apartment</option>
                        <option value="Condo">Condo</option>
                        <option value="Townhouse">Townhouse</option>
                    </select>
                </div>
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">Price ($/month)</label>
                    <input type="number" id="price" min="0" step="1" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 1200" required>
                </div>
                <div>
                    <label for="size" class="block text-sm font-medium text-gray-700">Size (sq ft, optional)</label>
                    <input type="number" id="size" min="0" step="1" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 500">
                </div>
                <div>
                    <label for="bedrooms" class="block text-sm font-medium text-gray-700">Bedrooms (optional)</label>
                    <input type="number" id="bedrooms" min="0" step="1" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 1">
                </div>
                <div>
                    <label for="amenities" class="block text-sm font-medium text-gray-700">Amenities (optional)</label>
                    <textarea id="amenities" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., Wi-Fi, Parking, Gym" rows="4"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button onclick="addRoom()" class="flex-1 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Add Room</button>
                    <button onclick="searchRooms()" class="flex-1 bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition font-semibold">Search All Sites</button>
                </div>
                <div>
                    <button onclick="messageFriend()" class="w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition font-semibold">Message Friend About Rental</button>
                </div>
            </div>
        </section>

        <!-- Room List -->
        <section>
            <div id="roomList" class="space-y-4"></div>
        </section>
    </main>

    <!-- About Section -->
    <section id="about" class="bg-gray-100 py-12">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">About Room Finder</h2>
            <p class="text-lg text-gray-600">Room Finder is a user-friendly platform designed to help you find and organize rooms that match your preferences. Whether you're looking for a cozy apartment or a spacious office, our tool simplifies the process with an intuitive interface.</p>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" class="bg-white py-12">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Contact Us</h2>
            <p class="text-lg text-gray-600 text-center mb-6">Have questions or need assistance? Reach out to our team!</p>
            <div class="flex justify-center">
                <a href="mailto:support@roomfinder.com" class="inline-block bg-blue-600 text-white px-8 py-3 rounded-full hover:bg-blue-700 transition font-semibold shadow-md hover:shadow-lg">Email Us</a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="index.html" class="hover:text-blue-400">Home</a>
                <a href="#about" class="hover:text-blue-400">About</a>
                <a href="sublease.html" class="hover:text-blue-400">Sublease</a>
                <a href="ai-negotiator.html" class="hover:text-blue-400">AI Negotiator</a>
                <a href="#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </footer>

    <!-- AI Chatbot -->
    <div class="fixed bottom-4 right-4 z-50">
        <button id="chatbotToggle" class="bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h8m-4-4v8"></path>
            </svg>
        </button>
        <div id="chatbotPopup" class="hidden fixed bottom-20 right-4 w-80 bg-white rounded-lg shadow-xl border border-gray-200">
            <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                <h3 class="text-lg font-semibold">Room Finder AI Assistant</h3>
            </div>
            <div id="chatMessages" class="p-4 h-64 overflow-y-auto">
                <p class="text-gray-600">Hello! I can help you find a room or message your friend about a rental. Try saying something like: 'Find a room in Toronto for $1000' or click 'Message Friend About Rental' above!</p>
            </div>
            <div class="p-4 border-t border-gray-200">
                <input id="chatInput" type="text" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message...">
                <button onclick="sendChatMessage()" class="mt-2 w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">Send</button>
            </div>
        </div>
    </div>

    <script>
        let rooms = [];
        let messageFriendMode = false;
        let messageCount = 0;
        let rentalData = {
            finalPrice: null,
            houseType: null,
            location: null,
            deposit: null,
            utilities: null,
            pets: null,
            parking: null,
            firstLastMonth: null,
            contract: null
        };
        let userProvided = {
            finalPrice: false,
            houseType: false,
            location: false,
            deposit: false,
            utilities: false,
            pets: false,
            parking: false,
            firstLastMonth: false,
            contract: false
        };
        let priceHistory = [];
        const WIT_AI_TOKEN = 'MEF6KIWW7YBERPO3WPAY5VIGGJFTXNLU';
        const questionsToAsk = [
            "What’s the final price per month?",
            "What type of house is it (e.g., apartment, house, condo)?",
            "Where is it located?",
            "How much is the deposit?",
            "Are utilities included?",
            "Are pets allowed?",
            "Is parking available?",
            "Do I need to pay first and last month’s rent upfront?",
            "Is there a contract or lease agreement?"
        ];
        let currentQuestionIndex = 0;

        function addRoom() {
            const location = document.getElementById('location').value.trim();
            const roomType = document.getElementById('roomType').value;
            const price = document.getElementById('price').value;
            const size = document.getElementById('size').value;
            const bedrooms = document.getElementById('bedrooms').value;
            const amenities = document.getElementById('amenities').value.trim();

            if (!location || !roomType || !price) {
                alert('Please fill in all required fields (Location, Room Type, Price).');
                return;
            }

            const room = { 
                location, 
                roomType,
                price: parseInt(price), 
                size: size ? parseInt(size) : null, 
                bedrooms: bedrooms ? parseInt(bedrooms) : null, 
                amenities 
            };
            rooms.push(room);
            renderRooms();

            document.getElementById('location').value = '';
            document.getElementById('roomType').value = '';
            document.getElementById('price').value = '';
            document.getElementById('size').value = '';
            document.getElementById('bedrooms').value = '';
            document.getElementById('amenities').value = '';
        }

        function renderRooms() {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';

            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card bg-white p-6 rounded-lg shadow-md';
                roomCard.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-800">${room.location}</h2>
                    <p class="text-gray-600">Type: ${room.roomType}</p>
                    <p class="text-gray-600">Price: $${room.price.toLocaleString()}/month</p>
                    ${room.size ? `<p class="text-gray-600">Size: ${room.size.toLocaleString()} sq ft</p>` : ''}
                    ${room.bedrooms ? `<p class="text-gray-600">Bedrooms: ${room.bedrooms}</p>` : ''}
                    ${room.amenities ? `<p class="text-gray-600">Amenities: ${room.amenities}</p>` : ''}
                `;
                roomList.appendChild(roomCard);
            });
        }

        async function searchRooms() {
            const location = document.getElementById('location').value.trim();
            const roomType = document.getElementById('roomType').value;
            const price = document.getElementById('price').value;
            const size = document.getElementById('size').value;
            const bedrooms = document.getElementById('bedrooms').value;
            const amenities = document.getElementById('amenities').value.trim();

            if (!location || !roomType || !price) {
                alert('Please fill in all required fields (Location, Room Type, Price).');
                return;
            }

            const requestBody = { location, roomType, price, size: size ? parseInt(size) : null, bedrooms: bedrooms ? parseInt(bedrooms) : null, amenities };
            let kijijiUrl = '', marketplaceUrl = '';

            try {
                const kijijiResponse = await fetch('http://localhost:3000/api/predict/kijiji', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (kijijiResponse.ok) {
                    const { url } = await kijijiResponse.json();
                    kijijiUrl = url;
                } else {
                    const errorData = await kijijiResponse.json();
                    console.warn(`Kijiji fetch failed: ${errorData.error || 'Unknown error'}`);
                }
                console.log('Kijiji URL:', kijijiUrl);

                const marketplaceResponse = await fetch('http://localhost:3000/api/predict/marketplace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (marketplaceResponse.ok) {
                    const { url } = await marketplaceResponse.json();
                    marketplaceUrl = url;
                } else {
                    const errorData = await marketplaceResponse.json();
                    console.warn(`Marketplace fetch failed: ${errorData.error || 'Unknown error'}`);
                }
                console.log('Marketplace URL:', marketplaceUrl);

                if (kijijiUrl) window.open(kijijiUrl, '_blank');
                if (marketplaceUrl) window.open(marketplaceUrl, '_blank');
                if (!kijijiUrl && !marketplaceUrl) {
                    throw new Error('Failed to generate URLs for both Kijiji and Marketplace');
                }

                document.getElementById('location').value = '';
                document.getElementById('roomType').value = '';
                document.getElementById('price').value = '';
                document.getElementById('size').value = '';
                document.getElementById('bedrooms').value = '';
                document.getElementById('amenities').value = '';
            } catch (error) {
                alert(`Error searching: ${error.message}`);
                console.error('Search error:', error);
            }
        }

        // Chatbot functionality
        document.getElementById('chatbotToggle').addEventListener('click', () => {
            const popup = document.getElementById('chatbotPopup');
            popup.classList.toggle('hidden');
        });

        function appendMessage(sender, message, align) {
            const messages = document.getElementById('chatMessages');
            const messageElement = document.createElement('p');
            messageElement.className = `text-${align} text-${sender === 'You' || sender === 'Friend' ? 'blue-600' : 'gray-600'} mt-2`;
            messageElement.textContent = `${sender}: ${message}`;
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        async function queryWitAI(message) {
            try {
                const response = await fetch(`https://api.wit.ai/message?v=20250509&q=${encodeURIComponent(message)}`, {
                    headers: { 'Authorization': `Bearer ${WIT_AI_TOKEN}` }
                });
                if (!response.ok) {
                    throw new Error(`Wit.ai API error: ${response.status} - ${response.statusText}`);
                }
                const data = await response.json();
                console.log(`Wit.ai response for "${message}":`, JSON.stringify(data, null, 2));
                return data;
            } catch (error) {
                console.error(`Wit.ai error for message "${message}":`, error);
                appendMessage('AI', 'Sorry, I had trouble understanding that. Let’s try again.', 'left');
                return null;
            }
        }

        function messageFriend() {
            messageFriendMode = true;
            messageCount = 0;
            rentalData = {
                finalPrice: null,
                houseType: null,
                location: null,
                deposit: null,
                utilities: null,
                pets: null,
                parking: null,
                firstLastMonth: null,
                contract: null
            };
            userProvided = {
                finalPrice: false,
                houseType: false,
                location: false,
                deposit: false,
                utilities: false,
                pets: false,
                parking: false,
                firstLastMonth: false,
                contract: false
            };
            priceHistory = [];
            currentQuestionIndex = 0;

            const messages = document.getElementById('chatMessages');
            messages.innerHTML = '';
            appendMessage('AI', 'Hi! I’m here to help gather details about the rental property. Let’s start with: What’s the final price per month?', 'left');

            const popup = document.getElementById('chatbotPopup');
            if (popup.classList.contains('hidden')) {
                popup.classList.remove('hidden');
            }
        }

        function suggestNextQuestion() {
            if (currentQuestionIndex < questionsToAsk.length) {
                appendMessage('AI', `Suggestion: Ask "${questionsToAsk[currentQuestionIndex]}"`, 'left');
            }
        }

        function summarizeRentalData() {
            const summary = [
                `Here’s what I gathered about the rental:`,
                `Final Price: ${rentalData.finalPrice ? `$${rentalData.finalPrice}` : 'Not provided'}`,
                `House Type: ${rentalData.houseType || 'Not provided'}`,
                `Location: ${rentalData.location || 'Not provided'}`,
                `Deposit: ${rentalData.deposit ? `$${rentalData.deposit}` : 'Not provided'}`,
                `Utilities Included: ${rentalData.utilities !== null ? (rentalData.utilities ? 'Yes' : 'No') : 'Not provided'}`,
                `Pets Allowed: ${rentalData.pets !== null ? (rentalData.pets ? 'Yes' : 'No') : 'Not provided'}`,
                `Parking Available: ${rentalData.parking !== null ? (rentalData.parking ? 'Yes' : 'No') : 'Not provided'}`,
                `First/Last Month Required: ${rentalData.firstLastMonth !== null ? (rentalData.firstLastMonth ? 'Yes' : 'No') : 'Not provided'}`,
                `Contract Required: ${rentalData.contract !== null ? (rentalData.contract ? 'Yes' : 'No') : 'Not provided'}`
            ].join('\n');
            appendMessage('AI', summary, 'left');
            messageFriendMode = false;
        }

        async function processFriendMessage(message, isSimulated = false) {
            messageCount++;
            appendMessage('Friend', message, 'right');

            const witData = await queryWitAI(message);
            if (witData) {
                const entities = witData.entities;
                const lowerMessage = message.toLowerCase();

                // wit$amount_of_money:final_price and wit$amount_of_money:deposit
                if (entities['wit$amount_of_money:final_price']) {
                    const moneyEntities = entities['wit$amount_of_money:final_price'];
                    for (const moneyEntity of moneyEntities) {
                        const value = moneyEntity.value;
                        const hasRole = moneyEntity.role && moneyEntity.role.length > 0;
                        if (hasRole && moneyEntity.role === 'final_price' || lowerMessage.includes('price') || lowerMessage.includes('final')) {
                            if (!isSimulated || !userProvided.finalPrice) {
                                priceHistory.push(value);
                                if (priceHistory.length > 1 && priceHistory[priceHistory.length - 1] !== priceHistory[priceHistory.length - 2]) {
                                    appendMessage('AI', `I noticed multiple prices: $${priceHistory.join(' and $')}. Which one is correct?`, 'left');
                                    return;
                                }
                                rentalData.finalPrice = value;
                                if (!isSimulated) userProvided.finalPrice = true;
                            }
                        }
                    }
                }
                if (entities['wit$amount_of_money:deposit']) {
                    const moneyEntities = entities['wit$amount_of_money:deposit'];
                    for (const moneyEntity of moneyEntities) {
                        const value = moneyEntity.value;
                        const hasRole = moneyEntity.role && moneyEntity.role.length > 0;
                        if (hasRole && moneyEntity.role === 'deposit' || lowerMessage.includes('deposit')) {
                            if (!isSimulated || !userProvided.deposit) {
                                rentalData.deposit = value;
                                if (!isSimulated) userProvided.deposit = true;
                            }
                        } else if (currentQuestionIndex === 3 || lowerMessage.includes('deposit')) {
                            if (!isSimulated || !userProvided.deposit) {
                                rentalData.deposit = value;
                                if (!isSimulated) userProvided.deposit = true;
                            }
                        }
                    }
                }

                // house_type:house_type
                if (entities['house_type:house_type']) {
                    if (!isSimulated || !userProvided.houseType) {
                        rentalData.houseType = entities['house_type:house_type'][0].value;
                        if (!isSimulated) userProvided.houseType = true;
                    }
                }

                // wit$location:location
                if (entities['wit$location:location']) {
                    if (!isSimulated || !userProvided.location) {
                        const locationEntity = entities['wit$location:location'][0];
                        rentalData.location = locationEntity.resolved?.values?.[0]?.name || locationEntity.value;
                        if (!isSimulated) userProvided.location = true;
                    }
                }

                // yes_no:yes_no (utilities, pets, parking, first/last, contract)
                if (entities['yes_no:yes_no']) {
                    const yesNo = entities['yes_no:yes_no'][0].value === 'yes';
                    if (lowerMessage.includes('utilities')) {
                        if (!isSimulated || !userProvided.utilities) {
                            rentalData.utilities = yesNo;
                            if (!isSimulated) userProvided.utilities = true;
                        }
                    } else if (lowerMessage.includes('pets')) {
                        if (!isSimulated || !userProvided.pets) {
                            rentalData.pets = yesNo;
                            if (!isSimulated) userProvided.pets = true;
                        }
                    } else if (lowerMessage.includes('parking')) {
                        if (!isSimulated || !userProvided.parking) {
                            rentalData.parking = yesNo;
                            if (!isSimulated) userProvided.parking = true;
                        }
                    } else if (lowerMessage.includes('first') || lowerMessage.includes('last')) {
                        if (!isSimulated || !userProvided.firstLastMonth) {
                            rentalData.firstLastMonth = yesNo;
                            if (!isSimulated) userProvided.firstLastMonth = true;
                        }
                    } else if (lowerMessage.includes('contract') || lowerMessage.includes('lease')) {
                        if (!isSimulated || !userProvided.contract) {
                            rentalData.contract = yesNo;
                            if (!isSimulated) userProvided.contract = true;
                        }
                    } else {
                        // Infer based on question index if context is unclear
                        if (currentQuestionIndex === 4 && (!isSimulated || !userProvided.utilities)) {
                            rentalData.utilities = yesNo;
                            if (!isSimulated) userProvided.utilities = true;
                        }
                        else if (currentQuestionIndex === 5 && (!isSimulated || !userProvided.pets)) {
                            rentalData.pets = yesNo;
                            if (!isSimulated) userProvided.pets = true;
                        }
                        else if (currentQuestionIndex === 6 && (!isSimulated || !userProvided.parking)) {
                            rentalData.parking = yesNo;
                            if (!isSimulated) userProvided.parking = true;
                        }
                        else if (currentQuestionIndex === 7 && (!isSimulated || !userProvided.firstLastMonth)) {
                            rentalData.firstLastMonth = yesNo;
                            if (!isSimulated) userProvided.firstLastMonth = true;
                        }
                        else if (currentQuestionIndex === 8 && (!isSimulated || !userProvided.contract)) {
                            rentalData.contract = yesNo;
                            if (!isSimulated) userProvided.contract = true;
                        }
                    }
                }
            }

            // Simulate friend's response (for testing purposes)
            if (!isSimulated) {
                setTimeout(async () => {
                    let friendResponse = '';
                    if (currentQuestionIndex === 0) friendResponse = 'The final price is $1200 per month.';
                    else if (currentQuestionIndex === 1) friendResponse = 'It’s an apartment.';
                    else if (currentQuestionIndex === 2) friendResponse = 'It’s located in Toronto.';
                    else if (currentQuestionIndex === 3) friendResponse = 'The deposit is $500.';
                    else if (currentQuestionIndex === 4) friendResponse = 'Yes, utilities are included.';
                    else if (currentQuestionIndex === 5) friendResponse = 'No, pets are not allowed.';
                    else if (currentQuestionIndex === 6) friendResponse = 'Yes, parking is available.';
                    else if (currentQuestionIndex === 7) friendResponse = 'Yes, you need to pay first and last month’s rent.';
                    else if (currentQuestionIndex === 8) friendResponse = 'Yes, there’s a 1-year lease contract.';
                    else friendResponse = 'That’s all the info I have!';

                    if (friendResponse) {
                        await processFriendMessage(friendResponse, true);
                    }
                }, 1000);
            } else {
                currentQuestionIndex++;
                if (messageCount >= 6) {
                    summarizeRentalData();
                } else {
                    if (currentQuestionIndex < questionsToAsk.length) {
                        appendMessage('AI', questionsToAsk[currentQuestionIndex], 'left');
                    }
                    suggestNextQuestion();
                }
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            if (messageFriendMode) {
                await processFriendMessage(message);
            } else {
                appendMessage('You', message, 'right');
                await processChatMessage(message);
            }
            input.value = '';
        }

        async function processChatMessage(message) {
            const lowerMessage = message.toLowerCase();
            const searchKeywords = ['find', 'search', 'look for', 'room', 'apartment', 'house', 'condo', 'townhouse'];
            const hasSearchIntent = searchKeywords.some(keyword => lowerMessage.includes(keyword));

            if (hasSearchIntent) {
                let location = '', price = '', roomType = '', size = '', bedrooms = '', amenities = '';
                const locationMatch = lowerMessage.match(/(?:in|at)\s+([a-z\s,]+)(?:\s+for|$)/i);
                if (locationMatch) location = locationMatch[1].trim();
                const priceMatch = lowerMessage.match(/\$?(\d+)(?:\s*dollars)?/i);
                if (priceMatch) price = priceMatch[1];
                const roomTypes = ['house', 'apartment', 'condo', 'townhouse'];
                roomType = roomTypes.find(type => lowerMessage.includes(type)) || 'Apartment';
                const sizeMatch = lowerMessage.match(/(\d+)\s*(?:sq\s*ft|square\s*feet)/i);
                if (sizeMatch) size = sizeMatch[1];
                const bedroomsMatch = lowerMessage.match(/(\d+)\s*bedroom/i);
                if (bedroomsMatch) bedrooms = bedroomsMatch[1];
                const amenitiesList = ['wi-fi', 'parking', 'gym', 'pool', 'laundry'];
                amenities = amenitiesList.filter(amenity => lowerMessage.includes(amenity)).join(', ');

                if (location && price) {
                    document.getElementById('location').value = location;
                    document.getElementById('roomType').value = roomType.charAt(0).toUpperCase() + roomType.slice(1);
                    document.getElementById('price').value = price;
                    if (size) document.getElementById('size').value = size;
                    if (bedrooms) document.getElementById('bedrooms').value = bedrooms;
                    if (amenities) document.getElementById('amenities').value = amenities;

                    appendMessage('AI', `Got it! Searching for a ${roomType} in ${location} for $${price}/month${size ? `, ${size} sq ft` : ''}${bedrooms ? `, ${bedrooms} bedrooms` : ''}${amenities ? ` with ${amenities}` : ''}. Opening search results...`, 'left');
                    await searchRooms();
                } else {
                    appendMessage('AI', 'I need a location and price to search for a room. Try saying: "Find a room in Toronto for $1000".', 'left');
                }
                return;
            }

            if (lowerMessage.includes('how') || lowerMessage.includes('work') || lowerMessage.includes('what')) {
                appendMessage('AI', 'Room Finder helps you search for rooms on Kijiji and Facebook Marketplace. Enter details like location and price in the form above, or ask me to search for you (e.g., "Find a room in Toronto for $1000"). You can also save rooms to your list or message your friend about a rental!', 'left');
            } else if (lowerMessage.includes('sublease') || lowerMessage.includes('ai negotiator')) {
                appendMessage('AI', `For "${message}", check out our Sublease page for subletting options or use the AI Negotiator to get pricing tips!`, 'left');
            } else {
                appendMessage('AI', `I'm not sure how to help with "${message}". Try asking to find a room (e.g., "Find a room in Toronto for $1000") or click 'Message Friend About Rental' to gather details from your friend!`, 'left');
            }
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    </script>
</body>
</html>