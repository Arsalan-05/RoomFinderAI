<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - AI Negotiator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/typo-js@1.2.3/typo.js"></script>
    <style>
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .typing-indicator {
            color: #6b7280; /* gray-500 */
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="/index" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="/index#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="/sublease" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="/ai-negotiator" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="/index#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- AI Negotiator Section -->
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Negotiator</h2>
            <p class="text-lg text-gray-600 mb-6 text-center">Chat with our AI Negotiator to get pricing tips, negotiation strategies, and rental details for your search.</p>
            <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <h3 class="text-lg font-semibold">AI Negotiator Assistant</h3>
                </div>
                <div id="chatMessages" class="p-4">
                    <p class="text-gray-600">Hello! I'm here to help you negotiate your rental. Please provide details about the rental, such as price, location, house type, bedrooms, utilities, pets, deposit, parking, first/last month’s rent, and contract.</p>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <input id="chatInput" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Type your message...">
                    <button onclick="sendChatMessage()" class="mt-3 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Send</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/index" class="hover:text-blue-400">Home</a>
                <a href="/index#about" class="hover:text-blue-400">About</a>
                <a href="/sublease" class="hover:text-blue-400">Sublease</a>
                <a href="/ai-negotiator" class="hover:text-blue-400">AI Negotiator</a>
                <a href="/index#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Typo.js for autocorrect
        const typo = new Typo('en_US', false, false, {
            dictionaryPath: 'https://unpkg.com/typo-js@1.2.3/dictionaries'
        });

        // Wit.ai client access token
        const WIT_AI_TOKEN = 'MEF6KIWW7YBERPO3WPAY5VIGGJFTXNLU';

        let isTyping = false;
        let rentalData = {
            price: null,
            location: null,
            houseType: null,
            bedrooms: null,
            utilities: null,
            pets: null,
            deposit: null,
            parking: null,
            firstLastMonth: null,
            contract: null
        };
        let priceHistory = [];

        function populateSearchSummary() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomData = urlParams.get('roomData');
                console.log('populateSearchSummary: Received roomData', roomData);

                if (!roomData) {
                    console.warn('populateSearchSummary: No roomData parameter found in URL');
                    return;
                }

                let searchData;
                try {
                    searchData = JSON.parse(decodeURIComponent(roomData));
                    console.log('populateSearchSummary: Parsed searchData', searchData);
                } catch (parseError) {
                    console.error('populateSearchSummary: Error parsing roomData', parseError);
                    appendMessage('AI', 'Invalid search details format. Please provide the rental details manually.', 'left');
                    return;
                }

                // Validate required fields
                if (!searchData.location || !searchData.roomType || !searchData.price) {
                    console.warn('populateSearchSummary: Missing required fields', searchData);
                    appendMessage('AI', 'Incomplete search details. Please provide the rental details manually.', 'left');
                    return;
                }

                // Store data in rentalData
                rentalData.price = searchData.price;
                priceHistory.push(searchData.price);
                rentalData.houseType = searchData.roomType;
                rentalData.location = searchData.location;
                rentalData.bedrooms = searchData.bedrooms || null;
                rentalData.utilities = searchData.amenities && searchData.amenities.includes('Utilities') ? 'Included' : null;
                rentalData.pets = searchData.amenities && searchData.amenities.includes('Pet friendly') ? 'Allowed' : null;

                // Display summary
                displayRentalSummary();
            } catch (error) {
                console.error('populateSearchSummary: General error', error);
                appendMessage('AI', 'Error loading search details. Please provide the rental details manually.', 'left');
            }
        }

        function appendMessage(sender, message, align, isTypingIndicator = false) {
            const messages = document.getElementById('chatMessages');
            const messageElement = document.createElement('p');
            messageElement.className = `text-${align} text-${sender === 'User' ? 'blue-600' : 'gray-600'} mt-2 ${isTypingIndicator ? 'typing-indicator' : ''}`;
            messageElement.textContent = isTypingIndicator ? message : `${sender}: ${message}`;
            messageElement.id = isTypingIndicator ? 'typing-indicator' : '';
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function autocorrectInput(input) {
            // Skip autocorrect for monetary values to prevent altering $2000
            if (input.match(/\$[\d,]+/)) {
                console.log('autocorrectInput: Skipping autocorrect for monetary value:', input);
                return input;
            }
            const words = input.split(' ');
            const correctedWords = words.map(word => {
                if (typo.check(word)) return word;
                const suggestions = typo.suggest(word);
                return suggestions.length > 0 ? suggestions[0] : word;
            });
            return correctedWords.join(' ');
        }

        async function processWitResponse(message) {
            const correctedMessage = autocorrectInput(message);
            console.log('Original:', message, 'Corrected:', correctedMessage);

            try {
                if (!WIT_AI_TOKEN || WIT_AI_TOKEN === 'YOUR_WIT_AI_CLIENT_ACCESS_TOKEN') {
                    throw new Error('Wit.ai client access token is missing or invalid. Please provide a valid token.');
                }

                const response = await fetch(`https://api.wit.ai/message?v=20250512&q=${encodeURIComponent(correctedMessage)}`, {
                    headers: {
                        'Authorization': `Bearer ${WIT_AI_TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Wit.ai API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Wit.ai response:', JSON.stringify(data, null, 2));

                // Reset rentalData
                rentalData = {
                    price: null,
                    location: null,
                    houseType: null,
                    bedrooms: null,
                    utilities: null,
                    pets: null,
                    deposit: null,
                    parking: null,
                    firstLastMonth: null,
                    contract: null
                };

                // Extract entities from Wit.ai response
                const entities = data.entities || {};
                let validationErrors = [];

                // Price (wit$amount_of_money:amount_of_money)
                if (entities['wit$amount_of_money:amount_of_money']) {
                    const priceEntity = entities['wit$amount_of_money:amount_of_money'][0];
                    rentalData.price = Number(priceEntity.value); // Ensure numerical value
                    console.log('Extracted price:', rentalData.price, 'from entity:', priceEntity);
                    if (rentalData.price < 100) {
                        validationErrors.push(`Price ($${rentalData.price}/month) seems unusually low. Did you mean a higher amount (e.g., $2000)?`);
                    }
                    priceHistory.push(rentalData.price);
                }

                // Location (wit$location:specific_area)
                if (entities['wit$location:specific_area']) {
                    rentalData.location = entities['wit$location:specific_area'][0].value;
                }

                // House Type (property_type:specific_type)
                if (entities['property_type:specific_type']) {
                    rentalData.houseType = entities['property_type:specific_type'][0].value;
                }

                // Bedrooms (bedrooms:minimum_required)
                if (entities['bedrooms:minimum_required']) {
                    rentalData.bedrooms = entities['bedrooms:minimum_required'][0].value;
                    if (!/^\d+$/.test(rentalData.bedrooms) && !rentalData.bedrooms.includes('at least')) {
                        validationErrors.push(`Bedrooms (${rentalData.bedrooms}) seems unclear. Please specify a number (e.g., "2").`);
                    }
                }

                // Utilities (utilities:included_or_not)
                if (entities['utilities:included_or_not']) {
                    rentalData.utilities = entities['utilities:included_or_not'][0].value === 'included' ? 'Included' : 'Not included';
                }

                // Pets (amenities:pet_policy)
                if (entities['amenities:pet_policy']) {
                    rentalData.pets = entities['amenities:pet_policy'][0].value === 'pet friendly' ? 'Allowed' : 'Not allowed';
                }

                // Deposit (wit$amount_of_money:deposit)
                if (entities['wit$amount_of_money:deposit']) {
                    rentalData.deposit = Number(entities['wit$amount_of_money:deposit'][0].value);
                }

                // Parking (parking:parking)
                if (entities['parking:parking']) {
                    rentalData.parking = entities['parking:parking'][0].value === 'available' ? 'Available' : 'Not available';
                }

                // First/Last Month’s Rent (first_last_month:first_last_month)
                if (entities['first_last_month:first_last_month']) {
                    rentalData.firstLastMonth = entities['first_last_month:first_last_month'][0].value === 'required' ? 'Required' : 'Not required';
                }

                // Contract (contract:contract)
                if (entities['contract:contract']) {
                    rentalData.contract = entities['contract:contract'][0].value === 'required' ? 'Required' : 'Not required';
                }

                // Display summary of extracted entities
                let summaryMessage = 'Here’s what I understood from your message:';
                let entitiesExtracted = false;

                if (entities['wit$amount_of_money:amount_of_money']) {
                    summaryMessage += ` - Price: $${rentalData.price}/month (Confidence: ${entities['wit$amount_of_money:amount_of_money'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['wit$location:specific_area']) {
                    summaryMessage += ` - Location: ${rentalData.location} (Confidence: ${entities['wit$location:specific_area'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['property_type:specific_type']) {
                    summaryMessage += ` - House Type: ${rentalData.houseType} (Confidence: ${entities['property_type:specific_type'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['bedrooms:minimum_required']) {
                    summaryMessage += ` - Bedrooms: ${rentalData.bedrooms} (Confidence: ${entities['bedrooms:minimum_required'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['utilities:included_or_not']) {
                    summaryMessage += ` - Utilities: ${rentalData.utilities} (Confidence: ${entities['utilities:included_or_not'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['amenities:pet_policy']) {
                    summaryMessage += ` - Pets: ${rentalData.pets} (Confidence: ${entities['amenities:pet_policy'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['wit$amount_of_money:deposit']) {
                    summaryMessage += ` - Deposit: $${rentalData.deposit} (Confidence: ${entities['wit$amount_of_money:deposit'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['parking:parking']) {
                    summaryMessage += ` - Parking: ${rentalData.parking} (Confidence: ${entities['parking:parking'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['first_last_month:first_last_month']) {
                    summaryMessage += ` - First/Last Month’s Rent: ${rentalData.firstLastMonth} (Confidence: ${entities['first_last_month:first_last_month'][0].confidence})`;
                    entitiesExtracted = true;
                }
                if (entities['contract:contract']) {
                    summaryMessage += ` - Contract: ${rentalData.contract} (Confidence: ${entities['contract:contract'][0].confidence})`;
                    entitiesExtracted = true;
                }

                if (!entitiesExtracted) {
                    appendMessage('AI', 'I couldn’t understand any rental details. Please provide details like price, location, house type, bedrooms, utilities, pets, etc.', 'left');
                    return;
                }

                // Add validation warnings if any
                if (validationErrors.length > 0) {
                    summaryMessage += '\n\nWarnings:\n' + validationErrors.join('\n');
                }

                summaryMessage += '\nPlease confirm if this is correct or provide additional details.';
                appendMessage('AI', summaryMessage, 'left');
            } catch (error) {
                console.error('Error processing Wit.ai response:', error.message);
                appendMessage('AI', `Sorry, something went wrong: ${error.message}. Please check your Wit.ai token or try again.`, 'left');
            }
        }

        function displayRentalSummary() {
            let summary = 'Current rental details:';
            summary += rentalData.price ? ` - Price: $${rentalData.price}/month` : ' - Price: Not provided';
            summary += rentalData.location ? ` - Location: ${rentalData.location}` : ' - Location: Not provided';
            summary += rentalData.houseType ? ` - House Type: ${rentalData.houseType}` : ' - House Type: Not provided';
            summary += rentalData.bedrooms ? ` - Bedrooms: ${rentalData.bedrooms}` : ' - Bedrooms: Not provided';
            summary += rentalData.utilities ? ` - Utilities: ${rentalData.utilities}` : ' - Utilities: Not provided';
            summary += rentalData.pets ? ` - Pets: ${rentalData.pets}` : ' - Pets: Not provided';
            summary += rentalData.deposit ? ` - Deposit: $${rentalData.deposit}` : ' - Deposit: Not provided';
            summary += rentalData.parking ? ` - Parking: ${rentalData.parking}` : ' - Parking: Not provided';
            summary += rentalData.firstLastMonth ? ` - First/Last Month’s Rent: ${rentalData.firstLastMonth}` : ' - First/Last Month’s Rent: Not provided';
            summary += rentalData.contract ? ` - Contract: ${rentalData.contract}` : ' - Contract: Not provided';
            summary += ' Please confirm if this is correct or provide additional details.';
            appendMessage('AI', summary, 'left');
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Remove typing indicator and append user message
            removeTypingIndicator();
            isTyping = false;
            appendMessage('User', message, 'right');
            input.value = ''; // Clear input field

            // Process message with Wit.ai for entity extraction
            appendMessage('AI', 'Processing your request...', 'left', true);
            await processWitResponse(message);
            removeTypingIndicator();
        }

        // Initialize by checking for URL parameters
        window.onload = function() {
            populateSearchSummary();
        };
    </script>
</body>
</html>