<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - AI Negotiator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/typo-js@1.2.3/typo.js"></script>
    <style>
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .typing-indicator {
            color: #6b7280;
            font-style: italic;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f7fafc;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
            margin: 0 auto;
            padding: 20px;
            width: 80%;
        }
        section {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 3rem;
        }
        h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        p {
            font-size: 1.125rem;
            color: #4a5568;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        input, button {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        button {
            background-color: #2563eb;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #1d4ed8;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="/index" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="/index#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="/sublease" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="/ai-negotiator" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="/listings" class="text-gray-700 hover:text-blue-600 transition font-medium">Listings</a>
                <a href="/index#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
        </nav>
    </header>
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Negotiator</h2>
            <p class="text-lg text-gray-600 mb-6 text-center">Chat with our AI Negotiator to get pricing tips, negotiation strategies, add listings, or get rental details.</p>
            <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <h3 class="text-lg font-semibold">AI Negotiator Assistant</h3>
                </div>
                <div id="chatMessages" class="p-4">
                    <p class="text-gray-600">Hello! I'm here to help you negotiate your rental or add a listing. Provide details like price, bedrooms, and house type, or say "add a listing" to create one.</p>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <input id="chatInput" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Type your message...">
                    <button onclick="sendChatMessage()" class="mt-3 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Send</button>
                </div>
            </div>
        </section>
    </main>
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">Â© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/index" class="hover:text-blue-400">Home</a>
                <a href="/index#about" class="hover:text-blue-400">About</a>
                <a href="/sublease" class="hover:text-blue-400">Sublease</a>
                <a href="/ai-negotiator" class="hover:text-blue-400">AI Negotiator</a>
                <a href="/index#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </div>
    </footer>
    <script>
        // Initialize Typo.js for autocorrect
        let typo = null;
        if (typeof Typo !== 'undefined') {
            try {
                typo = new Typo('en_US', false, false, {
                    dictionaryPath: 'https://unpkg.com/typo-js@1.2.3/dictionaries'
                });
                console.log('Typo.js initialized successfully');
                typo.dictionary['roomfinder'] = 1;
                typo.dictionary['wifi'] = 1;
                typo.dictionary['appartment'] = 1;
                typo.dictionary['condo'] = 1;
                typo.dictionary['sublease'] = 1;
                typo.dictionary['negoitator'] = 1;
            } catch (error) {
                console.error('Failed to initialize Typo.js:', error);
                typo = null;
            }
        } else {
            console.warn('Typo.js library not loaded. Autocorrect will be disabled.');
        }

        // API configurations
        const WIT_AI_TOKEN = 'LZNNBHEOSZBZG7IPS6ZOPWCR6WQF3LUL';
        const OPENAI_API_KEY = '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';
        const OPENAI_MODEL = 'gpt-3.5-turbo';

        // State variables
        let isTyping = false;
        let rentalData = {
            price: null,
            location: null,
            houseType: null,
            bedrooms: null,
            utilities: null,
            pets: null,
            deposit: null,
            parking: null,
            firstLastMonth: null,
            contract: null
        };
        let priceHistory = [];
        let negotiationState = 'idle'; // idle, offered, finalized
        let lastOffer = null;
        let conversationHistory = [];
        let lastMessageTime = 0; // Track last message timestamp for debouncing

        // Append message to chat and update history
        function appendMessage(sender, message, align, isTypingIndicator = false) {
            const messages = document.getElementById('chatMessages');
            if (!messages) {
                console.error('Error: #chatMessages element not found');
                return;
            }
            const messageElement = document.createElement('p');
            messageElement.className = `text-${align} text-${sender === 'User' ? 'blue-600' : 'gray-600'} mt-2 ${isTypingIndicator ? 'typing-indicator' : ''}`;
            messageElement.textContent = isTypingIndicator ? message : `${sender}: ${message}`;
            messageElement.id = isTypingIndicator ? 'typing-indicator' : '';
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
            if (!isTypingIndicator) conversationHistory.push({ role: sender.toLowerCase(), content: message });
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
        }

        // Autocorrect user input
        function autocorrectInput(input) {
            if (!typo) {
                console.log('Autocorrect disabled: Typo.js not available');
                return input;
            }
            if (input.match(/\$[\d,]+/)) {
                console.log('Skipping autocorrect for monetary value:', input);
                return input;
            }
            const words = input.split(' ');
            const correctedWords = words.map(word => {
                if (typo.check(word)) return word;
                const suggestions = typo.suggest(word);
                return suggestions.length > 0 ? suggestions[0] : word;
            });
            return correctedWords.join(' ');
        }

        // Delay function for retry mechanism
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Mock displayListings for UI update (used in Listings page)
        function displayListings() {
            console.log('displayListings called (stub for Listings page)');
            // Actual implementation should be in listings.html
        }

        // Function to add listing via AI
        async function addListingViaAI(message) {
            const prompt = `
            You are an AI assistant for RoomFinderAI. The user has requested to add a listing with the following message: "${message}".
            Extract the following details from the message to create a listing:
            - Title (create a concise title if not explicitly provided, e.g., "2-Bedroom Apartment in [Location]")
            - Price (in dollars per month, numeric)
            - Location (city, state/province, country if provided)
            - House Type (e.g., Apartment, Condo, House, Townhouse)
            - Bedrooms (numeric)
            - Utilities (Included or Not included, default to Not included if unclear)
            - Description (summarize the property details if not explicitly provided)

            Return a JSON object with these fields. If any information is missing, use reasonable defaults or indicate "Not specified". Ensure the response is valid JSON.
            Example response:
            {
                "title": "2-Bedroom Apartment in Toronto",
                "price": 1200,
                "location": "Toronto, Ontario, Canada",
                "houseType": "Apartment",
                "bedrooms": 2,
                "utilities": "Not included",
                "description": "Cozy apartment near downtown."
            }
            `;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{ role: 'system', content: prompt }],
                        max_tokens: 200,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                let listing;
                try {
                    listing = JSON.parse(data.choices[0].message.content.trim());
                } catch (parseError) {
                    throw new Error('Invalid JSON response from OpenAI');
                }

                const newListing = {
                    title: listing.title || 'New Listing',
                    price: Number(listing.price) || 1000,
                    location: listing.location || 'Not specified',
                    houseType: listing.houseType || 'Apartment',
                    bedrooms: Number(listing.bedrooms) || 1,
                    utilities: listing.utilities || 'Not included',
                    description: listing.description || 'No description provided',
                    media: []
                };

                // Validate required fields
                if (!newListing.title || isNaN(newListing.price) || !newListing.location || !newListing.houseType || isNaN(newListing.bedrooms)) {
                    throw new Error('Missing or invalid required fields in listing');
                }

                let listings = JSON.parse(localStorage.getItem('listings')) || [];
                listings.push(newListing);
                localStorage.setItem('listings', JSON.stringify(listings));

                // Attempt to update UI if on Listings page
                if (typeof displayListings === 'function') {
                    displayListings();
                }

                return {
                    success: true,
                    listing: newListing
                };
            } catch (error) {
                console.error('Error adding AI listing:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Step 1: Parse user message with Wit.ai
        async function parseWithWitAI(message, retryCount = 0) {
            const correctedMessage = autocorrectInput(message);
            appendMessage('User', correctedMessage, 'right');
            appendMessage('AI', 'Processing your request...', 'left', true);

            const now = Date.now();
            if (now - lastMessageTime < 5000) { // Debounce: 5 seconds
                removeTypingIndicator();
                appendMessage('AI', 'Please wait 5 seconds before sending another message.', 'left');
                return;
            }
            lastMessageTime = now;

            // Check for listing addition intent
            if (correctedMessage.toLowerCase().includes('add a listing') || correctedMessage.toLowerCase().includes('create a listing')) {
                removeTypingIndicator();
                const result = await addListingViaAI(correctedMessage);
                if (result.success) {
                    const listing = result.listing;
                    appendMessage('AI', `Listing added successfully! Title: ${listing.title}, Price: $${listing.price}/month, Location: ${listing.location}. Check the Listings page.`, 'left');
                } else {
                    appendMessage('AI', `Failed to add listing: ${result.error}. Please provide more details and try again.`, 'left');
                }
                return;
            }

            try {
                const response = await fetch(`https://api.wit.ai/message?v=20250512&q=${encodeURIComponent(correctedMessage)}`, {
                    headers: {
                        'Authorization': `Bearer ${WIT_AI_TOKEN}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 429 && retryCount < 3) {
                        const waitTime = Math.pow(2, retryCount + 1) * 1000; // 2s, 4s, 8s
                        appendMessage('AI', `Wit.ai rate limit hit, retrying in ${waitTime/1000} seconds...`, 'left', true);
                        await delay(waitTime);
                        return parseWithWitAI(message, retryCount + 1);
                    }
                    throw new Error(`Wit.ai API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const entities = data.entities || {};
                let intent = data.intents && data.intents.length > 0 ? data.intents[0].name : null;

                // Extract entities
                if (entities['wit$amount_of_money:amount_of_money']) {
                    const priceEntity = entities['wit$amount_of_money:amount_of_money'].find(e => e.role === 'price') || entities['wit$amount_of_money:amount_of_money'][0];
                    rentalData.price = Number(priceEntity.value);
                    priceHistory.push(rentalData.price);
                }
                if (entities['wit$location:location']) {
                    rentalData.location = entities['wit$location:location'][0].value;
                }
                if (entities['property_type:house_type']) {
                    rentalData.houseType = entities['property_type:house_type'][0].value;
                } else if (correctedMessage.toLowerCase().includes('condo') || correctedMessage.toLowerCase().includes('apartment')) {
                    rentalData.houseType = correctedMessage.toLowerCase().includes('condo') ? 'Condo' : 'Apartment';
                }
                if (entities['bedrooms:bedrooms']) {
                    rentalData.bedrooms = entities['bedrooms:bedrooms'][0].value;
                }
                if (entities['utilities:utilities']) {
                    rentalData.utilities = entities['utilities:utilities'][0].value === 'included' ? 'Included' : 'Not included';
                }
                if (entities['pet_policy:pets']) {
                    rentalData.pets = entities['pet_policy:pets'][0].value === 'allowed' ? 'Allowed' : 'Not allowed';
                }
                if (entities['wit$amount_of_money:deposit']) {
                    rentalData.deposit = Number(entities['wit$amount_of_money:deposit'][0].value);
                }
                if (entities['parking:parking']) {
                    rentalData.parking = entities['parking:parking'][0].value === 'available' ? 'Available' : 'Not available';
                }
                if (entities['first_last_month:first_last_month']) {
                    rentalData.firstLastMonth = entities['first_last_month:first_last_month'][0].value === 'required' ? 'Required' : 'Not required';
                }
                if (entities['contract:contract']) {
                    rentalData.contract = entities['contract:contract'][0].value === 'required' ? 'Required' : 'Not required';
                }

                // Pass to OpenAI for negotiation
                await negotiateWithOpenAI(correctedMessage, intent);
            } catch (error) {
                console.error('Wit.ai API error:', error.message);
                removeTypingIndicator();
                appendMessage('AI', `Sorry, an error occurred with Wit.ai: ${error.message}. Please try again.`, 'left');
            }
        }

        // Step 2: Negotiate with OpenAI
        async function negotiateWithOpenAI(message, intent, retryCount = 0) {
            const prompt = `
            You are an AI negotiator assisting a user in renting a property. Use the parsed rental details and manage the negotiation. Current state:
            - Negotiation state: ${negotiationState}
            - Rental data: ${JSON.stringify(rentalData)}
            - Price history: ${priceHistory.join(', ')}
            - Last offer: $${lastOffer || 'none'}
            - Conversation history: ${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}
            - Intent: ${intent || 'none'}
            - User message: ${message}

            ### Instructions:
            1. Manage negotiation:
               - If state is 'idle' and intent is 'request_negotiation' or message contains "negotiate", suggest a 5% lower offer and set state to 'offered'.
               - If state is 'offered' and user/landlord accepts (e.g., "Yes", "Can you do $${lastOffer}?"), finalize with last offer and set state to 'finalized'.
               - If a new price is offered (e.g., "Can you do $1400?"), update price, set state to 'finalized', and confirm.
               - If unclear, ask for clarification.
            2. Respond with "AI:" followed by a concise, conversational message (1-2 sentences).
            `;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{ role: 'system', content: prompt }],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    if (response.status === 429 && retryCount < 3) {
                        const waitTime = Math.pow(2, retryCount + 1) * 1000; // 2s, 4s, 8s
                        appendMessage('AI', `OpenAI rate limit hit, retrying in ${waitTime/1000} seconds...`, 'left', true);
                        await delay(waitTime);
                        return negotiateWithOpenAI(message, intent, retryCount + 1);
                    }
                    throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content.trim();
                removeTypingIndicator();
                appendMessage('AI', aiResponse.replace('AI:', '').trim(), 'left');

                // Update state based on OpenAI's response
                if (negotiationState === 'idle' && (intent === 'request_negotiation' || message.toLowerCase().includes('negotiate')) && rentalData.price) {
                    lastOffer = Math.round(rentalData.price * 0.95);
                    negotiationState = 'offered';
                } else if (negotiationState === 'offered' && (message.toLowerCase().includes('yes') || message.toLowerCase().includes(`can you do $${lastOffer}`))) {
                    negotiationState = 'finalized';
                    rentalData.price = lastOffer;
                    priceHistory.push(lastOffer);
                } else if (negotiationState === 'offered' && message.match(/\$([\d,]+)/)) {
                    const newPrice = parseInt(message.match(/\$([\d,]+)/)[1].replace(',', ''));
                    if (newPrice !== lastOffer) {
                        rentalData.price = newPrice;
                        priceHistory.push(newPrice);
                        lastOffer = newPrice;
                        negotiationState = 'finalized';
                    }
                }
            } catch (error) {
                console.error('OpenAI API error:', error.message);
                removeTypingIndicator();
                appendMessage('AI', `Sorry, an error occurred with OpenAI: ${error.message}. Please try again or check your OpenAI plan at platform.openai.com.`, 'left');
            }
        }

        // Send user message to Wit.ai for parsing, then OpenAI for negotiation
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            removeTypingIndicator();
            isTyping = false;
            await parseWithWitAI(message);
            input.value = '';
        }

        // Initialize chat on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded at', new Date().toISOString());
            appendMessage('AI', 'Hello! I\'m here to help you negotiate your rental or add a listing. Provide details like price, bedrooms, and house type, or say "add a listing" to create one.', 'left');
        });
    </script>
</body>
</html>