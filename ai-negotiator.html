<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - AI Negotiator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/typo-js@1.2.3/typo.js"></script>
    <style>
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .typing-indicator {
            color: #6b7280; /* gray-500 */
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="/index" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="/index#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="/sublease" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="/ai-negotiator" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="/index#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- AI Negotiator Section -->
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Negotiator</h2>
            <p class="text-lg text-gray-600 mb-6 text-center">Chat with our AI Negotiator to get pricing tips, negotiation strategies, and rental details for your search.</p>
            <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <h3 class="text-lg font-semibold">AI Negotiator Assistant</h3>
                </div>
                <div id="chatMessages" class="p-4">
                    <p class="text-gray-600">Hello! I'm here to help you negotiate your rental. Please provide details about the rental, such as price, location, house type, deposit, utilities, pets, parking, first/last month’s rent, and contract.</p>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <input id="chatInput" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Type your message...">
                    <button onclick="sendChatMessage()" class="mt-3 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Send</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/index" class="hover:text-blue-400">Home</a>
                <a href="/index#about" class="hover:text-blue-400">About</a>
                <a href="/sublease" class="hover:text-blue-400">Sublease</a>
                <a href="/ai-negotiator" class="hover:text-blue-400">AI Negotiator</a>
                <a href="/index#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Typo.js for autocorrect
        const typo = new Typo('en_US', false, false, {
            dictionaryPath: 'https://unpkg.com/typo-js@1.2.3/dictionaries'
        });

        // Wit.ai client access token (replace with your token)
        const WIT_AI_TOKEN = 'YOUR_WIT_AI_CLIENT_ACCESS_TOKEN';

        let isTyping = false;
        let rentalData = {
            finalPrice: null,
            houseType: null,
            location: null,
            deposit: null,
            utilities: null,
            pets: null,
            parking: null,
            firstLastMonth: null,
            contract: null
        };
        let priceHistory = [];
        let negotiationCompleted = false;

        function populateSearchSummary() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomData = urlParams.get('roomData');
                console.log('populateSearchSummary: Received roomData', roomData);

                if (!roomData) {
                    console.warn('populateSearchSummary: No roomData parameter found in URL');
                    return;
                }

                let searchData;
                try {
                    searchData = JSON.parse(decodeURIComponent(roomData));
                    console.log('populateSearchSummary: Parsed searchData', searchData);
                } catch (parseError) {
                    console.error('populateSearchSummary: Error parsing roomData', parseError);
                    appendMessage('AI', 'Invalid search details format. Please provide the rental details manually.', 'left');
                    return;
                }

                // Validate required fields
                if (!searchData.location || !searchData.roomType || !searchData.price) {
                    console.warn('populateSearchSummary: Missing required fields', searchData);
                    appendMessage('AI', 'Incomplete search details. Please provide the rental details manually.', 'left');
                    return;
                }

                const textMessage = `I'm looking for a ${searchData.roomType} in ${searchData.location} for $${searchData.price}/month${searchData.size ? `, ${searchData.size} sq ft` : ''}${searchData.bedrooms ? `, ${searchData.bedrooms} bedrooms` : ''}${searchData.amenities ? ` with ${searchData.amenities}` : ''}. Can you help me negotiate the best deal?`;

                console.log('populateSearchSummary: Setting textMessage', textMessage);
                appendMessage('User', textMessage, 'right');
                appendMessage('AI', 'Got it! I can help with negotiation tips for this rental. Try offering 5-10% below the listed price to start. Would you like specific phrasing for your offer?', 'left');
                negotiationCompleted = true;

                // Pre-fill rental data from roomData
                rentalData.finalPrice = searchData.price;
                priceHistory.push(searchData.price);
                rentalData.houseType = searchData.roomType;
                rentalData.location = searchData.location;
            } catch (error) {
                console.error('populateSearchSummary: General error', error);
                appendMessage('AI', 'Error loading search details. Please provide the rental details manually.', 'left');
            }
        }

        function appendMessage(sender, message, align, isTypingIndicator = false) {
            const messages = document.getElementById('chatMessages');
            const messageElement = document.createElement('p');
            messageElement.className = `text-${align} text-${sender === 'User' ? 'blue-600' : 'gray-600'} mt-2 ${isTypingIndicator ? 'typing-indicator' : ''}`;
            messageElement.textContent = isTypingIndicator ? message : `${sender}: ${message}`;
            messageElement.id = isTypingIndicator ? 'typing-indicator' : '';
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function autocorrectInput(input) {
            const words = input.split(' ');
            const correctedWords = words.map(word => {
                if (typo.check(word)) return word;
                const suggestions = typo.suggest(word);
                return suggestions.length > 0 ? suggestions[0] : word;
            });
            return correctedWords.join(' ');
        }

        async function processWitResponse(message) {
            const correctedMessage = autocorrectInput(message);
            console.log('Original:', message, 'Corrected:', correctedMessage);

            try {
                const response = await fetch(`https://api.wit.ai/message?v=20250512&q=${encodeURIComponent(correctedMessage)}`, {
                    headers: {
                        'Authorization': `Bearer ${WIT_AI_TOKEN}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`Wit.ai API error: ${response.statusText}`);
                }
                const data = await response.json();
                console.log('Wit.ai response:', data);

                // Reset rentalData
                rentalData = {
                    finalPrice: null,
                    houseType: null,
                    location: null,
                    deposit: null,
                    utilities: null,
                    pets: null,
                    parking: null,
                    firstLastMonth: null,
                    contract: null
                };

                // Extract entities from Wit.ai response
                const entities = data.entities || {};

                // Price (assuming wit/amount_of_money entity)
                if (entities['wit$amount_of_money:amount_of_money']) {
                    rentalData.finalPrice = entities['wit$amount_of_money:amount_of_money'][0].value;
                    priceHistory.push(rentalData.finalPrice);
                }

                // House Type (custom entity: house_type)
                if (entities['house_type:house_type']) {
                    rentalData.houseType = entities['house_type:house_type'][0].value;
                }

                // Location (wit/location)
                if (entities['wit$location:location']) {
                    rentalData.location = entities['wit$location:location'][0].value;
                }

                // Deposit (wit/amount_of_money with role: deposit)
                if (entities['wit$amount_of_money:deposit']) {
                    rentalData.deposit = entities['wit$amount_of_money:deposit'][0].value;
                }

                // Utilities (custom entity: utilities)
                if (entities['utilities:utilities']) {
                    rentalData.utilities = entities['utilities:utilities'][0].value === 'included' ? 'Included' : 'Not included';
                }

                // Pets (custom entity: pets)
                if (entities['pets:pets']) {
                    rentalData.pets = entities['pets:pets'][0].value === 'allowed' ? 'Allowed' : 'Not allowed';
                }

                // Parking (custom entity: parking)
                if (entities['parking:parking']) {
                    rentalData.parking = entities['parking:parking'][0].value === 'available' ? 'Available' : 'Not available';
                }

                // First/Last Month’s Rent (custom entity: first_last_month)
                if (entities['first_last_month:first_last_month']) {
                    rentalData.firstLastMonth = entities['first_last_month:first_last_month'][0].value === 'required' ? 'Required' : 'Not required';
                }

                // Contract (custom entity: contract)
                if (entities['contract:contract']) {
                    rentalData.contract = entities['contract:contract'][0].value === 'required' ? 'Required' : 'Not required';
                }

                // Check if any data was extracted
                if (Object.values(rentalData).every(val => val === null)) {
                    appendMessage('AI', 'I couldn’t understand the rental details. Please provide details like price, location, house type, etc.', 'left');
                    return;
                }

                // Display summary
                displayRentalSummary();
            } catch (error) {
                console.error('Error processing Wit.ai response:', error);
                appendMessage('AI', 'Sorry, something went wrong while processing your input. Please try again.', 'left');
            }
        }

        function displayRentalSummary() {
            let summary = 'Here’s a summary of the rental details you provided:\n';
            summary += rentalData.finalPrice ? `- Final Price: $${rentalData.finalPrice}/month\n` : '- Final Price: Not provided\n';
            summary += rentalData.houseType ? `- House Type: ${rentalData.houseType}\n` : '- House Type: Not provided\n';
            summary += rentalData.location ? `- Location: ${rentalData.location}\n` : '- Location: Not provided\n';
            summary += rentalData.deposit ? `- Deposit: $${rentalData.deposit}\n` : '- Deposit: Not provided\n';
            summary += rentalData.utilities ? `- Utilities: ${rentalData.utilities}\n` : '- Utilities: Not provided\n';
            summary += rentalData.pets ? `- Pets: ${rentalData.pets}\n` : '- Pets: Not provided\n';
            summary += rentalData.parking ? `- Parking: ${rentalData.parking}\n` : '- Parking: Not provided\n';
            summary += rentalData.firstLastMonth ? `- First/Last Month’s Rent: ${rentalData.firstLastMonth}\n` : '- First/Last Month’s Rent: Not provided\n';
            summary += rentalData.contract ? `- Contract: ${rentalData.contract}\n` : '- Contract: Not provided\n';
            summary += 'Would you like to negotiate this rental or provide new details?';
            appendMessage('AI', summary.replace(/\n/g, ' '), 'left');
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Remove typing indicator and append user message
            removeTypingIndicator();
            isTyping = false;
            appendMessage('User', message, 'right');

            // Handle negotiation or post-summary actions
            const lowerMessage = message.toLowerCase();
            if (negotiationCompleted || lowerMessage.includes('negotiate') || lowerMessage.includes('price') || lowerMessage.includes('deal')) {
                if (lowerMessage.includes('phrasing') || lowerMessage.includes('offer')) {
                    let offerPrice = rentalData.finalPrice ? Math.round(rentalData.finalPrice * 0.9) : 'a lower price';
                    let roomType = rentalData.houseType || 'rental';
                    let location = rentalData.location || 'the location';
                    appendMessage('AI', `Here’s a sample offer: "Hi, I’m interested in the ${roomType} in ${location}. Would you consider $${offerPrice} per month? I’m a reliable tenant with good credit." Adjust as needed!`, 'left');
                } else {
                    appendMessage('AI', 'To negotiate a better deal, try offering 5-10% below the listed price and highlight your reliability as a tenant. Would you like specific phrasing for your offer?', 'left');
                }
            } else if (lowerMessage.includes('amenities') || lowerMessage.includes('utilities')) {
                appendMessage('AI', 'Ask the landlord if utilities or amenities like parking can be included in the rent to reduce your costs. Want me to draft a sample question?', 'left');
            } else if (lowerMessage.includes('new details')) {
                appendMessage('AI', 'Sure, please provide new rental details, such as price, location, house type, deposit, utilities, pets, parking, first/last month’s rent, and contract.', 'left');
                negotiationCompleted = false;
            } else {
                // Process input with Wit.ai to extract rental details
                await processWitResponse(message);
            }

            input.value = '';
        }

        document.getElementById('chatInput').addEventListener('input', (e) => {
            const input = e.target.value.trim();
            if (input && !isTyping) {
                isTyping = true;
                appendMessage('User', 'User is typing...', 'right', true);
            } else if (!input && isTyping) {
                removeTypingIndicator();
                isTyping = false;
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        document.addEventListener('DOMContentLoaded', populateSearchSummary);
    </script>
</body>
</html>