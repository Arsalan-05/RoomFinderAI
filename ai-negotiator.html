<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - AI Negotiator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/typo-js@1.2.3/typo.js"></script>
    <style>
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .typing-indicator {
            color: #6b7280; /* gray-500 */
            font-style: italic;
        }
        /* Fallback styles in case Tailwind fails */
        body {
            font-family: Arial, sans-serif;
            background-color: #f7fafc;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
            margin: 0 auto;
            padding: 20px;
            width: 80%;
        }
        section {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 3rem;
        }
        h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        p {
            font-size: 1.125rem;
            color: #4a5568;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        input, button {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        button {
            background-color: #2563eb;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #1d4ed8;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="/index" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="/index#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="/sublease" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="/ai-negotiator" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="/index#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Negotiator</h2>
            <p class="text-lg text-gray-600 mb-6 text-center">Chat with our AI Negotiator to get pricing tips, negotiation strategies, and rental details for your search.</p>
            <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <h3 class="text-lg font-semibold">AI Negotiator Assistant</h3>
                </div>
                <div id="chatMessages" class="p-4">
                    <p class="text-gray-600">Hello! I'm here to help you negotiate your rental. Please provide details about the rental, such as price, location, house type, bedrooms, utilities, pets, deposit, parking, first/last month’s rent, and contract.</p>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <input id="chatInput" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Type your message...">
                    <button onclick="sendChatMessage()" class="mt-3 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Send</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/index" class="hover:text-blue-400">Home</a>
                <a href="/index#about" class="hover:text-blue-400">About</a>
                <a href="/sublease" class="hover:text-blue-400">Sublease</a>
                <a href="/ai-negotiator" class="hover:text-blue-400">AI Negotiator</a>
                <a href="/index#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Typo.js for autocorrect with a fallback
        let typo = null;
        if (typeof Typo !== 'undefined') {
            try {
                typo = new Typo('en_US', false, false, {
                    dictionaryPath: 'https://unpkg.com/typo-js@1.2.3/dictionaries'
                });
                console.log('Typo.js initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Typo.js:', error);
                typo = null;
            }
        } else {
            console.warn('Typo.js library not loaded. Autocorrect will be disabled.');
        }

        // Wit.ai client access token
        const WIT_AI_TOKEN = 'LZNNBHEOSZBZG7IPS6ZOPWCR6WQF3LUL';

        let isTyping = false;
        let rentalData = {
            price: null,
            location: null,
            houseType: null,
            bedrooms: null,
            utilities: null,
            pets: null,
            deposit: null,
            parking: null,
            firstLastMonth: null,
            contract: null
        };
        let priceHistory = [];
        let marketplaceListing = null;
        let negotiationState = 'idle'; // idle, offered, finalized
        let lastOffer = null; // Track the last offer made

        // Mock function to parse Marketplace listing
        function parseMarketplaceListing(url) {
            if (url === 'https://www.facebook.com/marketplace/item/1988489131909148') {
                return {
                    title: '2 Bedroom Apartment in Downtown Toronto',
                    price: 2000,
                    location: 'Toronto, ON',
                    houseType: 'Apartment',
                    bedrooms: '2',
                    description: 'Cozy 2 bedroom apartment available for rent in downtown Toronto. Utilities included, pet-friendly.'
                };
            }
            return null;
        }

        function populateSearchSummary() {
            console.log('populateSearchSummary: Starting');
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomData = urlParams.get('roomData');
                const marketplaceUrl = urlParams.get('marketplaceUrl');
                console.log('populateSearchSummary: Received roomData', roomData, 'marketplaceUrl', marketplaceUrl);

                if (marketplaceUrl) {
                    marketplaceListing = parseMarketplaceListing(marketplaceUrl);
                    if (marketplaceListing) {
                        rentalData.price = marketplaceListing.price;
                        priceHistory.push(marketplaceListing.price);
                        rentalData.location = marketplaceListing.location;
                        rentalData.houseType = marketplaceListing.houseType;
                        rentalData.bedrooms = marketplaceListing.bedrooms;
                        rentalData.utilities = marketplaceListing.description.includes('Utilities included') ? 'Included' : 'Not included';
                        rentalData.pets = marketplaceListing.description.includes('pet-friendly') ? 'Allowed' : 'Not allowed';

                        let summary = `Found Marketplace listing: ${marketplaceListing.title}\n`;
                        summary += `- Price: $${marketplaceListing.price}/month\n`;
                        summary += `- Location: ${marketplaceListing.location}\n`;
                        summary += `- Type: ${marketplaceListing.houseType}\n`;
                        summary += `- Bedrooms: ${marketplaceListing.bedrooms}\n`;
                        summary += `- Utilities: ${rentalData.utilities}\n`;
                        summary += `- Pets: ${rentalData.pets}\n`;
                        summary += `Suggested message: "Hey, I’m from RoomFinder, I wanna rent."\n`;
                        summary += `Use the buttons below to copy the message and visit the listing to send it via Facebook Messenger. Would you like negotiation tips?`;
                        appendMessage('AI', summary, 'left');

                        document.getElementById('chatInput').value = 'Hey, I’m from RoomFinder, I wanna rent';
                        addActionButtons(marketplaceUrl);
                    } else {
                        appendMessage('AI', 'Could not fetch listing details. Please provide details manually.', 'left');
                    }
                } else if (roomData) {
                    let searchData;
                    try {
                        searchData = JSON.parse(decodeURIComponent(roomData));
                        console.log('populateSearchSummary: Parsed searchData', searchData);
                    } catch (parseError) {
                        console.error('populateSearchSummary: Error parsing roomData', parseError);
                        appendMessage('AI', 'Invalid search details format. Please provide the rental details manually.', 'left');
                        return;
                    }

                    if (!searchData.location || !searchData.roomType || !searchData.price) {
                        console.warn('populateSearchSummary: Missing required fields', searchData);
                        appendMessage('AI', 'Incomplete search details. Please provide the rental details manually.', 'left');
                        return;
                    }

                    rentalData.price = searchData.price;
                    priceHistory.push(searchData.price);
                    rentalData.houseType = searchData.roomType;
                    rentalData.location = searchData.location;
                    rentalData.bedrooms = searchData.bedrooms || null;
                    rentalData.utilities = searchData.amenities && searchData.amenities.includes('Utilities') ? 'Included' : null;
                    rentalData.pets = searchData.amenities && searchData.amenities.includes('Pet friendly') ? 'Allowed' : null;

                    displayRentalSummary();
                } else {
                    appendMessage('AI', 'No search details provided. Please provide the rental details manually.', 'left');
                }
            } catch (error) {
                console.error('populateSearchSummary: General error', error);
                appendMessage('AI', 'Error loading search details. Please provide the rental details manually.', 'left');
            }
        }

        function addActionButtons(marketplaceUrl) {
            const chatContainer = document.querySelector('#chatMessages');
            if (!chatContainer) {
                console.error('Error: #chatMessages element not found for adding action buttons');
                return;
            }
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex space-x-4 mt-4';
            
            const copyButton = document.createElement('button');
            copyButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition';
            copyButton.textContent = 'Copy Message';
            copyButton.onclick = () => {
                navigator.clipboard.writeText('Hey, I’m from RoomFinder, I wanna rent');
                appendMessage('AI', 'Message copied to clipboard!', 'left');
            };

            const visitButton = document.createElement('button');
            visitButton.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition';
            visitButton.textContent = 'Visit Listing';
            visitButton.onclick = () => {
                window.open(marketplaceUrl, '_blank');
                appendMessage('AI', 'Opened listing in a new tab. Paste the message in Facebook Messenger.', 'left');
            };

            buttonContainer.appendChild(copyButton);
            buttonContainer.appendChild(visitButton);
            chatContainer.appendChild(buttonContainer);
        }

        function appendMessage(sender, message, align, isTypingIndicator = false) {
            const messages = document.getElementById('chatMessages');
            if (!messages) {
                console.error('Error: #chatMessages element not found in the DOM');
                return;
            }
            const messageElement = document.createElement('p');
            messageElement.className = `text-${align} text-${sender === 'User' ? 'blue-600' : 'gray-600'} mt-2 ${isTypingIndicator ? 'typing-indicator' : ''}`;
            messageElement.textContent = isTypingIndicator ? message : `${sender}: ${message}`;
            messageElement.id = isTypingIndicator ? 'typing-indicator' : '';
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function autocorrectInput(input) {
            if (!typo) {
                console.log('Autocorrect disabled: Typo.js not available');
                return input; // Skip autocorrect if Typo.js isn't loaded
            }
            if (input.match(/\$[\d,]+/)) {
                console.log('autocorrectInput: Skipping autocorrect for monetary value:', input);
                return input;
            }
            const words = input.split(' ');
            const correctedWords = words.map(word => {
                if (typo.check(word)) return word;
                const suggestions = typo.suggest(word);
                return suggestions.length > 0 ? suggestions[0] : word;
            });
            return correctedWords.join(' ');
        }

        async function processWitResponse(message, isLandlord = false) {
            const correctedMessage = autocorrectInput(message);
            console.log('Original:', message, 'Corrected:', correctedMessage);

            try {
                if (!WIT_AI_TOKEN || WIT_AI_TOKEN === 'YOUR_WIT_AI_CLIENT_ACCESS_TOKEN') {
                    throw new Error('Wit.ai client access token is missing or invalid. Please provide a valid token.');
                }

                const response = await fetch(`https://api.wit.ai/message?v=20250512&q=${encodeURIComponent(correctedMessage)}`, {
                    headers: {
                        'Authorization': `Bearer ${WIT_AI_TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Wit.ai API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Wit.ai response:', JSON.stringify(data, null, 2));

                const entities = data.entities || {};
                let intent = data.intents && data.intents.length > 0 ? data.intents[0].name : null;
                let validationErrors = [];

                // Extract entities
                if (entities['wit$amount_of_money:amount_of_money']) {
                    const priceEntity = entities['wit$amount_of_money:amount_of_money'].find(e => e.role === 'price') || entities['wit$amount_of_money:amount_of_money'][0];
                    rentalData.price = Number(priceEntity.value);
                    console.log('Extracted price:', rentalData.price, 'from entity:', priceEntity);
                    if (rentalData.price < 100) {
                        validationErrors.push(`Price ($${rentalData.price}/month) seems unusually low. Did you mean a higher amount (e.g., $2000)?`);
                    }
                    priceHistory.push(rentalData.price);
                }

                if (entities['wit$location:location']) {
                    rentalData.location = entities['wit$location:location'][0].value;
                }

                if (entities['property_type:house_type']) {
                    rentalData.houseType = entities['property_type:house_type'][0].value;
                }

                if (entities['bedrooms:bedrooms']) {
                    const bedroomsEntity = entities['bedrooms:bedrooms'][0];
                    const bedroomsCount = bedroomsEntity.entities['wit$amount_of_money:amount_of_money']?.find(e => e.role === 'bedrooms_count');
                    rentalData.bedrooms = bedroomsCount ? bedroomsCount.value : bedroomsEntity.value;
                    if (!/^\d+$/.test(rentalData.bedrooms)) {
                        validationErrors.push(`Bedrooms (${rentalData.bedrooms}) seems unclear. Please specify a number (e.g., "2").`);
                    }
                }

                if (entities['utilities:utilities']) {
                    rentalData.utilities = entities['utilities:utilities'][0].value === 'included' ? 'Included' : 'Not included';
                }

                if (entities['pet_policy:pets']) {
                    rentalData.pets = entities['pet_policy:pets'][0].value === 'allowed' ? 'Allowed' : 'Not allowed';
                }

                if (entities['wit$amount_of_money:deposit']) {
                    rentalData.deposit = Number(entities['wit$amount_of_money:deposit'][0].value);
                }

                if (entities['parking:parking']) {
                    rentalData.parking = entities['parking:parking'][0].value === 'available' ? 'Available' : 'Not available';
                }

                if (entities['first_last_month:first_last_month']) {
                    rentalData.firstLastMonth = entities['first_last_month:first_last_month'][0].value === 'required' ? 'Required' : 'Not required';
                }

                if (entities['contract:contract']) {
                    rentalData.contract = entities['contract:contract'][0].value === 'required' ? 'Required' : 'Not required';
                }

                // Handle intents
                if (intent === 'request_negotiation' || (correctedMessage.toLowerCase() === 'yes' && negotiationState === 'idle')) {
                    if (!rentalData.price) {
                        appendMessage('AI', 'I understood this is a negotiation opportunity, but I don’t have the price. Please provide the price (e.g., "$2000").', 'left');
                        return;
                    }
                    const currentPrice = rentalData.price;
                    const newOffer = Math.round(currentPrice * 0.95); // 5% lower
                    lastOffer = newOffer;
                    negotiationState = 'offered';
                    appendMessage('AI', `The landlord is open to negotiation. The current price is $${currentPrice}/month. I suggest offering $${newOffer}/month. You can say: "Can you do $${newOffer}?"`, 'left');
                    return;
                }

                if (intent === 'provide_rental_details' || (correctedMessage.toLowerCase() === 'yes' && negotiationState !== 'offered')) {
                    let summaryMessage = 'Rental details provided:';
                    let entitiesExtracted = false;

                    if (rentalData.price) {
                        summaryMessage += ` - Price: $${rentalData.price}/month`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.location) {
                        summaryMessage += ` - Location: ${rentalData.location}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.houseType) {
                        summaryMessage += ` - House Type: ${rentalData.houseType}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.bedrooms) {
                        summaryMessage += ` - Bedrooms: ${rentalData.bedrooms}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.utilities) {
                        summaryMessage += ` - Utilities: ${rentalData.utilities}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.pets) {
                        summaryMessage += ` - Pets: ${rentalData.pets}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.deposit) {
                        summaryMessage += ` - Deposit: $${rentalData.deposit}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.parking) {
                        summaryMessage += ` - Parking: ${rentalData.parking}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.firstLastMonth) {
                        summaryMessage += ` - First/Last Month’s Rent: ${rentalData.firstLastMonth}`;
                        entitiesExtracted = true;
                    }
                    if (rentalData.contract) {
                        summaryMessage += ` - Contract: ${rentalData.contract}`;
                        entitiesExtracted = true;
                    }

                    if (!entitiesExtracted) {
                        appendMessage('AI', 'I couldn’t understand any rental details. Please provide details like price, house type, bedrooms, etc.', 'left');
                        return;
                    }

                    if (negotiationState === 'offered') {
                        negotiationState = 'finalized';
                        summaryMessage += `\n\nThis seems to be the landlord's final price after negotiation: $${rentalData.price}/month. Would you like to proceed with this price or negotiate further?`;
                    } else {
                        summaryMessage += '\nPlease confirm if this is correct or provide additional details.';
                    }

                    if (validationErrors.length > 0) {
                        summaryMessage += '\n\nWarnings:\n' + validationErrors.join('\n');
                    }

                    appendMessage('AI', summaryMessage, 'left');
                    return;
                }

                // Handle landlord response after an offer
                if (negotiationState === 'offered' && correctedMessage.toLowerCase().includes(`can you do $${lastOffer}`)) {
                    // Simulate landlord agreeing to the offer
                    appendMessage('AI', `Since you (the landlord) asked "Can you do $${lastOffer}?", I'll assume you're agreeing to the offer as a test. Let's say I (the landlord) respond: "Yes, I can do $${lastOffer} for the ${rentalData.bedrooms}-bedroom ${rentalData.houseType}."`, 'left');
                    await processWitResponse(`Yes, I can do $${lastOffer} for the ${rentalData.bedrooms}-bedroom ${rentalData.houseType}.`, true);
                    return;
                }

                if (negotiationState === 'offered') {
                    // Treat any other response as a new price or rejection
                    if (entities['wit$amount_of_money:amount_of_money']) {
                        negotiationState = 'finalized';
                        appendMessage('AI', `Rental details provided: - Price: $${rentalData.price}/month - House Type: ${rentalData.houseType} - Bedrooms: ${rentalData.bedrooms}\n\nThis seems to be the landlord's final price after negotiation: $${rentalData.price}/month. Would you like to proceed with this price or negotiate further?`, 'left');
                        return;
                    } else {
                        appendMessage('AI', 'I’ve already made an offer of $' + lastOffer + '/month. Please respond with the final price or let me know if you’re open to further negotiation.', 'left');
                        return;
                    }
                }

                // Fallback if no intent or unrecognized intent
                appendMessage('AI', 'I couldn’t understand the intent of your message. Please provide rental details or indicate if the landlord is open to negotiation.', 'left');
            } catch (error) {
                console.error('Error processing Wit.ai response:', error.message);
                appendMessage('AI', `Sorry, something went wrong: ${error.message}. Please check your Wit.ai token or try again.`, 'left');
            }
        }

        function displayRentalSummary() {
            let summary = 'Current rental details:';
            summary += rentalData.price ? ` - Price: $${rentalData.price}/month` : ' - Price: Not provided';
            summary += rentalData.location ? ` - Location: ${rentalData.location}` : ' - Location: Not provided';
            summary += rentalData.houseType ? ` - House Type: ${rentalData.houseType}` : ' - House Type: Not provided';
            summary += rentalData.bedrooms ? ` - Bedrooms: ${rentalData.bedrooms}` : ' - Bedrooms: Not provided';
            summary += rentalData.utilities ? ` - Utilities: ${rentalData.utilities}` : ' - Utilities: Not provided';
            summary += rentalData.pets ? ` - Pets: ${rentalData.pets}` : ' - Pets: Not provided';
            summary += rentalData.deposit ? ` - Deposit: $${rentalData.deposit}` : ' - Deposit: Not provided';
            summary += rentalData.parking ? ` - Parking: ${rentalData.parking}` : ' - Parking: Not provided';
            summary += rentalData.firstLastMonth ? ` - First/Last Month’s Rent: ${rentalData.firstLastMonth}` : ' - First/Last Month’s Rent: Not provided';
            summary += rentalData.contract ? ` - Contract: ${rentalData.contract}` : ' - Contract: Not provided';
            summary += ' Please confirm if this is correct or provide additional details.';
            appendMessage('AI', summary, 'left');
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            removeTypingIndicator();
            isTyping = false;
            appendMessage('User', message, 'right');
            input.value = '';

            appendMessage('AI', 'Processing your request...', 'left', true);
            await processWitResponse(message);
            removeTypingIndicator();
        }

        window.onload = function() {
            console.log('Window loaded, calling populateSearchSummary');
            populateSearchSummary();
        };
    </script>
</body>
</html>