<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - AI Negotiator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #chatMessages {
            height: 500px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #chatMessages::-webkit-scrollbar {
            width: 8px;
        }
        #chatMessages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chatMessages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chatMessages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .typing-indicator {
            color: #6b7280; /* gray-500 */
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="/index" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="/index#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="/sublease" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="/ai-negotiator" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="/index#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- AI Negotiator Section -->
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI Negotiator</h2>
            <p class="text-lg text-gray-600 mb-6 text-center">Chat with our AI Negotiator to get pricing tips, negotiation strategies, and rental details for your search.</p>
            <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div class="bg-blue-600 text-white p-4 rounded-t-lg">
                    <h3 class="text-lg font-semibold">AI Negotiator Assistant</h3>
                </div>
                <div id="chatMessages" class="p-4">
                    <p class="text-gray-600">Hello! I'm here to help you negotiate your rental and gather details about your rental needs. Let's get started.</p>
                </div>
                <div class="p-4 border-t border-gray-200">
                    <input id="chatInput" type="text" class="w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Type your message...">
                    <button onclick="sendChatMessage()" class="mt-3 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Send</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/index" class="hover:text-blue-400">Home</a>
                <a href="/index#about" class="hover:text-blue-400">About</a>
                <a href="/sublease" class="hover:text-blue-400">Sublease</a>
                <a href="/ai-negotiator" class="hover:text-blue-400">AI Negotiator</a>
                <a href="/index#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </div>
    </footer>

    <script>
        let isTyping = false;
        let rentalData = {
            finalPrice: null,
            houseType: null,
            location: null,
            deposit: null,
            utilities: null,
            pets: null,
            parking: null,
            firstLastMonth: null,
            contract: null
        };
        let userProvided = {
            finalPrice: false,
            houseType: false,
            location: false,
            deposit: false,
            utilities: false,
            pets: false,
            parking: false,
            firstLastMonth: false,
            contract: false
        };
        let priceHistory = [];
        const questionsToAsk = [
            "What’s the final price per month?",
            "What type of house is it (e.g., apartment, house, condo)?",
            "Where is it located?",
            "How much is the deposit?",
            "Are utilities included?",
            "Are pets allowed?",
            "Is parking available?",
            "Do I need to pay first and last month’s rent upfront?",
            "Is there a contract or lease agreement?"
        ];
        let currentQuestionIndex = 0;
        let isAskingRentalQuestions = false;
        let negotiationCompleted = false;

        function populateSearchSummary() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomData = urlParams.get('roomData');
                console.log('populateSearchSummary: Received roomData', roomData);

                if (!roomData) {
                    console.warn('populateSearchSummary: No roomData parameter found in URL');
                    const errorMessage = 'No search details provided. I’ll need to gather some rental details from you.';
                    appendMessage('AI', errorMessage, 'left');
                    startRentalQuestions();
                    return;
                }

                let searchData;
                try {
                    searchData = JSON.parse(decodeURIComponent(roomData));
                    console.log('populateSearchSummary: Parsed searchData', searchData);
                } catch (parseError) {
                    console.error('populateSearchSummary: Error parsing roomData', parseError);
                    const errorMessage = 'Invalid search details format. Let’s gather the rental details manually.';
                    appendMessage('AI', errorMessage, 'left');
                    startRentalQuestions();
                    return;
                }

                // Validate required fields
                if (!searchData.location || !searchData.roomType || !searchData.price) {
                    console.warn('populateSearchSummary: Missing required fields', searchData);
                    const errorMessage = 'Incomplete search details. Let’s gather the rental details manually.';
                    appendMessage('AI', errorMessage, 'left');
                    startRentalQuestions();
                    return;
                }

                const textMessage = `I'm looking for a ${searchData.roomType} in ${searchData.location} for $${searchData.price}/month${searchData.size ? `, ${searchData.size} sq ft` : ''}${searchData.bedrooms ? `, ${searchData.bedrooms} bedrooms` : ''}${searchData.amenities ? ` with ${searchData.amenities}` : ''}. Can you help me negotiate the best deal?`;

                console.log('populateSearchSummary: Setting textMessage', textMessage);
                appendMessage('User', textMessage, 'right');
                appendMessage('AI', 'Got it! I can help with negotiation tips for this rental. Try offering 5-10% below the listed price to start. Would you like specific phrasing for your offer?', 'left');
                negotiationCompleted = true;

                // Pre-fill rental data from roomData if available
                rentalData.finalPrice = searchData.price;
                userProvided.finalPrice = true;
                priceHistory.push(searchData.price);
                rentalData.houseType = searchData.roomType;
                userProvided.houseType = true;
                rentalData.location = searchData.location;
                userProvided.location = true;

                // Skip to the next unanswered question
                while (currentQuestionIndex < questionsToAsk.length && userProvided[Object.keys(userProvided)[currentQuestionIndex]]) {
                    currentQuestionIndex++;
                }

                if (currentQuestionIndex < questionsToAsk.length) {
                    appendMessage('AI', 'I also need some more details about your rental needs.', 'left');
                    startRentalQuestions();
                }
            } catch (error) {
                console.error('populateSearchSummary: General error', error);
                const errorMessage = 'Error loading search details. Let’s gather the rental details manually.';
                appendMessage('AI', errorMessage, 'left');
                startRentalQuestions();
            }
        }

        function appendMessage(sender, message, align, isTypingIndicator = false) {
            const messages = document.getElementById('chatMessages');
            const messageElement = document.createElement('p');
            messageElement.className = `text-${align} text-${sender === 'User' ? 'blue-600' : 'gray-600'} mt-2 ${isTypingIndicator ? 'typing-indicator' : ''}`;
            messageElement.textContent = isTypingIndicator ? message : `${sender}: ${message}`;
            messageElement.id = isTypingIndicator ? 'typing-indicator' : '';
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function startRentalQuestions() {
            isAskingRentalQuestions = true;
            if (currentQuestionIndex < questionsToAsk.length) {
                appendMessage('AI', questionsToAsk[currentQuestionIndex], 'left');
            } else {
                isAskingRentalQuestions = false;
                displayRentalSummary();
            }
        }

        function processRentalAnswer(message) {
            const lowerMessage = message.toLowerCase();
            const question = questionsToAsk[currentQuestionIndex].toLowerCase();

            if (question.includes('final price')) {
                const priceMatch = lowerMessage.match(/\d+/);
                rentalData.finalPrice = priceMatch ? parseInt(priceMatch[0]) : null;
                userProvided.finalPrice = true;
                if (rentalData.finalPrice) priceHistory.push(rentalData.finalPrice);
            } else if (question.includes('type of house')) {
                rentalData.houseType = message;
                userProvided.houseType = true;
            } else if (question.includes('located')) {
                rentalData.location = message;
                userProvided.location = true;
            } else if (question.includes('deposit')) {
                const depositMatch = lowerMessage.match(/\d+/);
                rentalData.deposit = depositMatch ? parseInt(depositMatch[0]) : null;
                userProvided.deposit = true;
            } else if (question.includes('utilities')) {
                rentalData.utilities = lowerMessage.includes('yes') ? 'Included' : 'Not included';
                userProvided.utilities = true;
            } else if (question.includes('pets')) {
                rentalData.pets = lowerMessage.includes('yes') ? 'Allowed' : 'Not allowed';
                userProvided.pets = true;
            } else if (question.includes('parking')) {
                rentalData.parking = lowerMessage.includes('yes') ? 'Available' : 'Not available';
                userProvided.parking = true;
            } else if (question.includes('first and last')) {
                rentalData.firstLastMonth = lowerMessage.includes('yes') ? 'Required' : 'Not required';
                userProvided.firstLastMonth = true;
            } else if (question.includes('contract')) {
                rentalData.contract = lowerMessage.includes('yes') ? 'Required' : 'Not required';
                userProvided.contract = true;
            }

            currentQuestionIndex++;
            if (currentQuestionIndex < questionsToAsk.length) {
                appendMessage('AI', questionsToAsk[currentQuestionIndex], 'left');
            } else {
                isAskingRentalQuestions = false;
                displayRentalSummary();
            }
        }

        function displayRentalSummary() {
            let summary = 'Here’s a summary of the rental details you provided:\n';
            summary += rentalData.finalPrice ? `- Final Price: $${rentalData.finalPrice}/month\n` : '- Final Price: Not provided\n';
            summary += rentalData.houseType ? `- House Type: ${rentalData.houseType}\n` : '- House Type: Not provided\n';
            summary += rentalData.location ? `- Location: ${rentalData.location}\n` : '- Location: Not provided\n';
            summary += rentalData.deposit ? `- Deposit: $${rentalData.deposit}\n` : '- Deposit: Not provided\n';
            summary += rentalData.utilities ? `- Utilities: ${rentalData.utilities}\n` : '- Utilities: Not provided\n';
            summary += rentalData.pets ? `- Pets: ${rentalData.pets}\n` : '- Pets: Not provided\n';
            summary += rentalData.parking ? `- Parking: ${rentalData.parking}\n` : '- Parking: Not provided\n';
            summary += rentalData.firstLastMonth ? `- First/Last Month’s Rent: ${rentalData.firstLastMonth}\n` : '- First/Last Month’s Rent: Not provided\n';
            summary += rentalData.contract ? `- Contract: ${rentalData.contract}\n` : '- Contract: Not provided\n';
            summary += 'Would you like to negotiate this rental or start over with new details?';
            appendMessage('AI', summary.replace(/\n/g, ' '), 'left');
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Remove typing indicator and append user message
            removeTypingIndicator();
            isTyping = false;
            appendMessage('User', message, 'right');

            // Check if we're in the rental question phase
            if (isAskingRentalQuestions) {
                processRentalAnswer(message);
            } else {
                // Handle negotiation or post-summary actions
                const lowerMessage = message.toLowerCase();
                if (lowerMessage.includes('phrasing') || lowerMessage.includes('offer')) {
                    let offerPrice = '';
                    let roomType = rentalData.houseType || 'rental';
                    let location = rentalData.location || 'the location';
                    if (rentalData.finalPrice) {
                        offerPrice = Math.round(rentalData.finalPrice * 0.9); // Suggest 10% below
                    } else {
                        const urlParams = new URLSearchParams(window.location.search);
                        const roomData = urlParams.get('roomData');
                        if (roomData) {
                            try {
                                const searchData = JSON.parse(decodeURIComponent(roomData));
                                const price = parseInt(searchData.price);
                                offerPrice = Math.round(price * 0.9);
                                roomType = searchData.roomType;
                                location = searchData.location;
                            } catch (e) {
                                console.error('sendChatMessage: Error parsing roomData for offer', e);
                            }
                        }
                    }
                    appendMessage('AI', `Here’s a sample offer: "Hi, I’m interested in the ${roomType} in ${location}. Would you consider $${offerPrice || 'a lower price'} per month? I’m a reliable tenant with good credit." Adjust as needed!`, 'left');
                } else if (lowerMessage.includes('negotiate') || lowerMessage.includes('price') || lowerMessage.includes('deal')) {
                    appendMessage('AI', 'To negotiate a better deal, try offering 5-10% below the listed price and highlight your reliability as a tenant. Would you like specific phrasing for your offer?', 'left');
                } else if (lowerMessage.includes('amenities') || lowerMessage.includes('utilities')) {
                    appendMessage('AI', 'Ask the landlord if utilities or amenities like parking can be included in the rent to reduce your costs. Want me to draft a sample question?', 'left');
                } else if (lowerMessage.includes('start over') || lowerMessage.includes('new details')) {
                    appendMessage('AI', 'Sure, let’s start over with new rental details.', 'left');
                    startRentalQuestions();
                } else {
                    appendMessage('AI', `I'm not sure how to respond to "${message}". Try asking about negotiating the price, amenities, lease terms, or say "start over" to provide new details!`, 'left');
                }
            }

            input.value = '';
        }

        document.getElementById('chatInput').addEventListener('input', (e) => {
            const input = e.target.value.trim();
            if (input && !isTyping) {
                isTyping = true;
                appendMessage('User', 'User is typing...', 'right', true);
            } else if (!input && isTyping) {
                removeTypingIndicator();
                isTyping = false;
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        document.addEventListener('DOMContentLoaded', populateSearchSummary);
    </script>
</body>
</html>