<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Finder - Listings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/typo-js@1.2.3/typo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7fafc;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .listing-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .listing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        #aiButton {
            transition: transform 0.3s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        #aiButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .custom-autocomplete {
            position: absolute;
            z-index: 1000;
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: calc(100% - 2rem);
            max-width: 400px;
            margin-top: 2px;
            max-height: 300px;
            overflow-y: auto;
        }
        .autocomplete-item {
            padding: 0.75rem;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #f3f4f6;
        }
        #location {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
        }
        .media-preview img, .media-preview video {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            margin: 0.5rem;
            border-radius: 0.25rem;
        }
        .listing-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
        }
        .listing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
        }
        .modal-media img, .modal-media video {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            margin: 0.5rem;
            border-radius: 0.25rem;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }
        .profile-logo {
            transition: transform 0.2s ease-in-out;
        }
        .profile-logo:hover {
            transform: scale(1.1);
        }
        .login-link {
            transition: color 0.2s ease-in-out;
        }
        .login-link:hover {
            color: #2563eb;
        }
        .chat-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .chat-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 10px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        .message.sent {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
        }
        .message.received {
            background-color: #e5e7eb;
            color: #1f2937;
            margin-right: auto;
        }
        .message-timestamp {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            resize: none;
        }
        .chat-send-btn {
            background-color: #3b82f6;
            color: white;
            padding: 10px 20px;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .chat-send-btn:hover {
            background-color: #2563eb;
        }
        .chat-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Header -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <nav class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="text-2xl font-bold text-blue-600">Room Finder</div>
                <a href="/index" class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="/index#about" class="text-gray-700 hover:text-blue-600 transition font-medium">About</a>
                <a href="/sublease" class="text-gray-700 hover:text-blue-600 transition font-medium">Sublease</a>
                <a href="/ai-negotiator" class="text-gray-700 hover:text-blue-600 transition font-medium">AI Negotiator</a>
                <a href="/listings" class="text-gray-700 hover:text-blue-600 transition font-medium">Listings</a>
                <a href="/index#contact" class="text-gray-700 hover:text-blue-600 transition font-medium">Contact Us</a>
            </div>
            <div id="authSection">
                <a href="/login" class="text-gray-700 hover:text-blue-600 transition font-medium login-link">Login/Register</a>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section id="home" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white py-20 text-center">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-4">Explore Our Listings</h1>
            <p class="text-lg sm:text-xl mb-6">Discover and add rental properties tailored to your needs with Room Finder.</p>
        </div>
    </section>

    <!-- Main Content -->
    <main class="flex-grow w-[80%] mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Add Listing Form -->
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8 mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Add a New Listing</h2>
            <p class="text-lg text-gray-600 mb-6 text-center">Fill out the form below to manually add a listing or use the AI Negotiator to create one automatically.</p>
            <form id="listingForm" class="space-y-6">
                <div class="relative">
                    <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="location" name="location" required class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., Toronto, Ontario, Canada" autocomplete="off" data-autocomplete="off">
                    <div id="autocomplete-dropdown" class="custom-autocomplete hidden"></div>
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="title" name="title" required class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., Cozy 2-Bedroom Apartment">
                </div>
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">Price ($/month)</label>
                    <input type="number" id="price" name="price" required min="0" step="1" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 1200">
                </div>
                <div>
                    <label for="houseType" class="block text-sm font-medium text-gray-700">House Type</label>
                    <select id="houseType" name="houseType" required class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        <option value="" disabled selected>Select a house type</option>
                        <option value="House">House</option>
                        <option value="Apartment">Apartment</option>
                        <option value="Condo">Condo</option>
                        <option value="Townhouse">Townhouse</option>
                    </select>
                </div>
                <div>
                    <label for="bedrooms" class="block text-sm font-medium text-gray-700">Bedrooms</label>
                    <input type="number" id="bedrooms" name="bedrooms" required min="0" step="1" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g., 2">
                </div>
                <div>
                    <label for="utilities" class="block text-sm font-medium text-gray-700">Utilities</label>
                    <select id="utilities" name="utilities" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        <option value="Included">Included</option>
                        <option value="Not included" selected>Not included</option>
                    </select>
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" name="description" rows="4" class="mt-1 w-full p-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Describe the property..."></textarea>
                </div>
                <div>
                    <label for="media" class="block text-sm font-medium text-gray-700">Attach Pictures or Videos (max 10MB, JPEG/PNG/MP4)</label>
                    <input type="file" id="media" name="media" accept="image/jpeg,image/png,video/mp4" multiple class="mt-1 w-full p-3 border border-gray-200 rounded-lg">
                    <div id="mediaPreview" class="media-preview flex flex-wrap mt-2"></div>
                </div>
                <div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold">Add Listing</button>
                </div>
            </form>
        </section>

        <!-- Listings Display -->
        <section class="bg-white rounded-xl shadow-xl p-6 sm:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Available Listings</h2>
            <button onclick="displayListings()" class="mb-4 bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">Refresh Listings</button>
            <div id="listingsContainer" class="listing-grid"></div>
            <div id="map"></div>
        </section>

        <!-- Modal for Listing Overview -->
        <div id="listingModal" class="modal">
            <div class="modal-content">
                <span class="close-button">×</span>
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4"></h2>
                <img id="modalImage" src="" alt="Listing" class="listing-image mb-4">
                <p id="modalPrice" class="text-xl font-bold text-blue-600 mb-2"></p>
                <p id="modalLocation" class="text-gray-600 mb-2"></p>
                <div id="modalDetails" class="text-gray-600 mb-4"></div>
                <p id="modalDescription" class="text-gray-600 mb-4"></p>
                <div id="modalMedia" class="modal-media flex flex-wrap mb-4"></div>
                <a id="modalViewDetails" href="#" class="inline-block bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold text-center w-full">View Details</a>
            </div>
        </div>

        <!-- Chat Modal -->
        <div id="chatModal" class="chat-modal">
            <div class="chat-modal-content">
                <div class="chat-header">
                    <h2 id="chatTitle" class="text-xl font-bold text-gray-800">Chat</h2>
                    <span class="close-button chat-close-button">×</span>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-container">
                    <textarea id="chatInput" class="chat-input" rows="2" placeholder="Type your message..."></textarea>
                    <button id="chatSendBtn" class="chat-send-btn">Send</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="w-[80%] mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">© 2025 Room Finder. All rights reserved.</p>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/index" class="hover:text-blue-400">Home</a>
                <a href="/index#about" class="hover:text-blue-400">About</a>
                <a href="/sublease" class="hover:text-blue-400">Sublease</a>
                <a href="/ai-negotiator" class="hover:text-blue-400">AI Negotiator</a>
                <a href="/listings" class="hover:text-blue-400">Listings</a>
                <a href="/index#contact" class="hover:text-blue-400">Contact</a>
            </div>
        </div>
    </footer>

    <!-- AI Button -->
    <div class="fixed bottom-4 right-4 z-50">
        <button id="aiButton" onclick="window.location.href='/ai-negotiator'" class="bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition flex items-center justify-center w-16 h-16">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </button>
    </div>

    <script type="text/javascript">
        // Authentication check and header update
        document.addEventListener('DOMContentLoaded', async () => {
            const profileImages = [
                'https://via.placeholder.com/40/FF6B6B',
                'https://via.placeholder.com/40/4ECDC4',
                'https://via.placeholder.com/40/FFE66D',
                'https://via.placeholder.com/40/6B7280',
                'https://via.placeholder.com/40/FF9F1C'
            ];
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const authSection = document.getElementById('authSection');

            if (!currentUser) {
                window.location.href = '/login';
                return;
            }

            // Set current user email for RLS
            try {
                const { error } = await supabase.rpc('set_current_user_email', { email: currentUser.email });
                if (error) {
                    console.error('Error setting current user email:', error);
                    alert('Failed to initialize session. Please try again.');
                    return;
                }
                console.log('Current user email set for RLS:', currentUser.email);
            } catch (err) {
                console.error('RPC call failed:', err);
                alert('Failed to initialize session. Please check your connection.');
                return;
            }

            if (!currentUser.profileImage) {
                currentUser.profileImage = profileImages[Math.floor(Math.random() * profileImages.length)];
                let users = JSON.parse(localStorage.getItem('users')) || [];
                users = users.map(u => u.email === currentUser.email ? currentUser : u);
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            authSection.innerHTML = `
                <a href="/profile">
                    <img id="profileLogo" src="${currentUser.profileImage}" alt="Profile" class="w-10 h-10 rounded-full profile-logo">
                </a>
            `;
            initMap();
            setupChat();
            await displayListings();
        });

        // Supabase Configuration
        const SUPABASE_URL = 'https://fkktwhjybuflxqzopaex.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZra3R3aGp5YnVmbHhxem9wYWV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0OTg5NzQsImV4cCI6MjA2MzA3NDk3NH0.4vdk_ozdi_jNNP1dxpAlGF2Km2detytIhN-lMNXNFHs';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            db: {
                schema: 'public'
            },
            global: {
                headers: { 'Content-Type': 'application/json' }
            }
        });

        // Initialize Typo.js for autocorrect
        const typo = new Typo('en_US', false, false, {
            dictionaryPath: 'https://unpkg.com/typo-js@1.2.3/dictionaries'
        });
        typo.dictionary['roomfinder'] = 1;
        typo.dictionary['wifi'] = 1;
        typo.dictionary['appartment'] = 1;
        typo.dictionary['condo'] = 1;
        typo.dictionary['sublease'] = 1;
        typo.dictionary['negoitator'] = 1;

        // Utility Functions
        function autocorrectInput(input) {
            if (typeof input !== 'string' || !input) return input;
            const words = input.split(' ');
            const correctedWords = words.map(word => {
                if (typo.check(word)) return word;
                const suggestions = typo.suggest(word);
                console.log(`Autocorrect: ${word} -> ${suggestions.length > 0 ? suggestions[0] : word}`);
                return suggestions.length > 0 ? suggestions[0] : word;
            });
            return correctedWords.join(' ');
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input.replace(/[^a-zA-Z0-9\s,.-]/g, '').trim();
        }

        // Load cities.json for autocomplete
        let cities = [];
        fetch('https://unpkg.com/cities.json@1.1.0/cities.json')
            .then(response => response.json())
            .then(data => {
                cities = data;
                console.log('Cities loaded:', cities.length);
            })
            .catch(error => {
                console.error('Error loading cities:', error);
                alert('Failed to load city data. Please enter locations manually.');
                document.getElementById('location').placeholder = 'Enter location manually (e.g., Toronto, Ontario, Canada)';
            });

        // Autocomplete logic
        const locationInput = document.getElementById('location');
        const dropdown = document.getElementById('autocomplete-dropdown');
        let debounceTimeout;

        function showSuggestions(input) {
            dropdown.innerHTML = '';
            dropdown.classList.add('hidden');
            if (!input || cities.length === 0) return;

            const filtered = cities
                .filter(city => 
                    city.name.toLowerCase().startsWith(input.toLowerCase()) ||
                    city.name.toLowerCase().includes(input.toLowerCase())
                )
                .slice(0, 10)
                .map(city => ({
                    display: `${city.name}${city.admin_name ? `, ${city.admin_name}` : ''}, ${city.country}`,
                    value: city
                }));

            if (filtered.length === 0) {
                const item = document.createElement('div');
                item.className = 'autocomplete-item text-gray-500';
                item.textContent = 'No matching cities';
                dropdown.appendChild(item);
                dropdown.classList.remove('hidden');
                return;
            }

            filtered.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = loc.display;
                item.addEventListener('click', () => {
                    locationInput.value = loc.display;
                    dropdown.classList.add('hidden');
                    console.log('Selected location:', loc.display);
                });
                dropdown.appendChild(item);
            });

            dropdown.classList.remove('hidden');
            console.log('Showing suggestions for:', input, filtered.map(f => f.display));
        }

        locationInput.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const value = locationInput.value.trim();
                console.log('Input event:', value);
                showSuggestions(value);
            }, 300);
        });

        locationInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !dropdown.classList.contains('hidden')) {
                const firstItem = dropdown.querySelector('.autocomplete-item:not(.text-gray-500)');
                if (firstItem) {
                    locationInput.value = firstItem.textContent;
                    dropdown.classList.add('hidden');
                    console.log('Enter key selected:', firstItem.textContent);
                }
                e.preventDefault();
            }
        });

        document.addEventListener('click', (e) => {
            if (!locationInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
                console.log('Dropdown hidden');
            }
        });

        // File upload and preview
        const mediaInput = document.getElementById('media');
        const mediaPreview = document.getElementById('mediaPreview');
        let uploadedFiles = [];

        mediaInput.addEventListener('change', () => {
            mediaPreview.innerHTML = '';
            uploadedFiles = [];
            const files = Array.from(mediaInput.files);
            let totalSize = 0;

            files.forEach(file => {
                totalSize += file.size;
                if (totalSize > 10 * 1024 * 1024) {
                    alert('Total file size exceeds 10MB limit.');
                    mediaInput.value = '';
                    mediaPreview.innerHTML = '';
                    uploadedFiles = [];
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    uploadedFiles.push({ name: file.name, type: file.type, data: dataUrl, file: file });
                    const previewElement = file.type.startsWith('image/')
                        ? `<img src="${dataUrl}" alt="${file.name}">`
                        : `<video src="${dataUrl}" controls></video>`;
                    const previewContainer = document.createElement('div');
                    previewContainer.innerHTML = previewElement;
                    mediaPreview.appendChild(previewContainer.firstChild);
                    console.log('Preview added for file:', file.name);
                };
                reader.readAsDataURL(file);
            });
            console.log('Files selected:', files.map(f => f.name));
        });

        // Upload media to Supabase
        async function uploadMedia(files) {
            const uploadedMedia = [];
            const storageApiUrl = `${SUPABASE_URL}/storage/v1/object/listing-media/Photos`;

            for (const fileObj of files) {
                const file = fileObj.file;
                const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const filePath = fileName;

                const extension = file.name.split('.').pop().toLowerCase();
                let contentType;
                switch (extension) {
                    case 'jpg':
                    case 'jpeg':
                        contentType = 'image/jpeg';
                        break;
                    case 'png':
                        contentType = 'image/png';
                        break;
                    case 'mp4':
                        contentType = 'video/mp4';
                        break;
                    default:
                        contentType = 'application/octet-stream';
                }

                console.log('Processing file:', { name: file.name, detectedType: file.type, assignedType: contentType });

                if (contentType.startsWith('image/')) {
                    const reader = new FileReader();
                    await new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => resolve();
                            img.onerror = () => reject(new Error('Invalid image file'));
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('cacheControl', '3600');
                formData.append('upsert', 'false');

                try {
                    const response = await fetch(`${storageApiUrl}/${filePath}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                    }

                    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/listing-media/Photos/${filePath}`;
                    let verifyResponse = await fetch(publicUrl, { method: 'HEAD' });
                    let serverContentType = verifyResponse.headers.get('Content-Type');
                    console.log('Server-reported content type:', { name: file.name, serverContentType });

                    if (serverContentType !== contentType) {
                        console.warn('MIME type mismatch detected. Server returned:', serverContentType, 'Expected:', contentType);
                        await fetch(`${storageApiUrl}/${filePath}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY
                            }
                        });

                        const reUploadFormData = new FormData();
                        reUploadFormData.append('file', file);
                        reUploadFormData.append('cacheControl', '3600');
                        reUploadFormData.append('upsert', 'false');
                        reUploadFormData.append('contentType', contentType);

                        const reUploadResponse = await fetch(`${storageApiUrl}/${filePath}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY
                            },
                            body: reUploadFormData
                        });

                        if (!reUploadResponse.ok) {
                            const errorText = await reUploadResponse.text();
                            throw new Error(`Re-upload failed: ${reUploadResponse.status} - ${errorText}`);
                        }

                        verifyResponse = await fetch(publicUrl, { method: 'HEAD' });
                        serverContentType = verifyResponse.headers.get('Content-Type');
                        console.log('After re-upload, server-reported content type:', { name: file.name, serverContentType });

                        if (serverContentType !== contentType) {
                            throw new Error(`Failed to set correct MIME type for ${file.name}. Server returned ${serverContentType}, expected ${contentType}.`);
                        }
                    }

                    console.log('Uploaded media:', { name: file.name, type: contentType, url: publicUrl });

                    uploadedMedia.push({
                        name: file.name,
                        type: contentType,
                        url: publicUrl,
                        data: fileObj.data
                    });
                } catch (err) {
                    console.error('Upload failed for', file.name, err);
                    throw err;
                }
            }

            return uploadedMedia;
        }

        // Initialize map
        let map;
        let markers = [];

        function initMap() {
            map = L.map('map').setView([43.6532, -79.3832], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            console.log('Map initialized');
        }

        // Geocode location using Nominatim API
        async function geocodeLocation(location) {
            try {
                const query = encodeURIComponent(location);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`);
                const data = await response.json();
                console.log('Geocode response for', location, ':', data);
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                console.warn('No coordinates found for location:', location);
                return null;
            } catch (error) {
                console.error('Error geocoding location:', location, error);
                return null;
            }
        }

        // Update map with listings
        async function updateMap(listings) {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            const validCoordinates = [];

            for (const listing of listings) {
                if (!listing.location) {
                    console.warn('Listing missing location:', listing);
                    continue;
                }

                const coords = await geocodeLocation(listing.location);
                if (coords) {
                    const marker = L.marker([coords.lat, coords.lon])
                        .addTo(map)
                        .bindPopup(`<b>${listing.title}</b><br>$${listing.price.toLocaleString()}/mo`);
                    markers.push(marker);
                    validCoordinates.push([coords.lat, coords.lon]);
                    console.log('Added marker for', listing.location, 'at', coords);
                }
            }

            if (validCoordinates.length > 0) {
                const bounds = L.latLngBounds(validCoordinates);
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            } else {
                map.setView([43.6532, -79.3832], 10);
            }
            console.log('Map updated with', markers.length, 'markers');
        }

        // Fetch listings from Supabase
        async function fetchListings() {
            try {
                const { data, error } = await supabase
                    .from('listings')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .range(0, 19);
                console.log('Fetched listings:', data);
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching listings:', error);
                alert('Failed to load listings: ' + error.message);
                return [];
            }
        }

        // Display listings
        async function displayListings() {
            const listings = await fetchListings();
            const container = document.getElementById('listingsContainer');
            container.innerHTML = '';

            if (listings.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center">No listings available.</p>';
                updateMap([]);
                return;
            }

            listings.forEach(listing => {
                console.log('Rendering listing:', listing);

                let media = listing.media || [];
                if (!Array.isArray(media)) {
                    console.warn('Media is not an array, resetting to empty array:', media);
                    media = [];
                }

                media = media.map(item => {
                    if (item.type === 'application/json' || !item.type || item.type === 'application/octet-stream') {
                        const extension = item.name.split('.').pop().toLowerCase();
                        let correctedType;
                        switch (extension) {
                            case 'jpg':
                            case 'jpeg':
                                correctedType = 'image/jpeg';
                                break;
                            case 'png':
                                correctedType = 'image/png';
                                break;
                            case 'mp4':
                                correctedType = 'video/mp4';
                                break;
                            default:
                                correctedType = item.type || 'application/octet-stream';
                        }
                        console.log('Corrected MIME type for', item.name, 'from', item.type, 'to', correctedType);
                        return { ...item, type: correctedType };
                    }
                    return item;
                });

                const isImage = (file) => {
                    const byType = file.type.startsWith('image/');
                    const byExtension = file.name.match(/\.(jpg|jpeg|png)$/i);
                    return byType || byExtension;
                };

                const primaryImage = media.length > 0 && isImage(media[0])
                    ? media[0].url
                    : 'https://via.placeholder.com/300x200?text=No+Image';

                fetch(primaryImage, { method: 'HEAD' })
                    .then(response => {
                        const serverContentType = response.headers.get('Content-Type');
                        console.log('Server content type for', primaryImage, ':', serverContentType);
                    })
                    .catch(err => console.error('Failed to fetch MIME type for', primaryImage, err));

                const listingCard = document.createElement('div');
                listingCard.className = 'listing-card bg-white rounded-lg shadow-md overflow-hidden';

                const hasOwner = !!listing.user_email;
                listingCard.innerHTML = `
                    <img src="${primaryImage}" alt="${listing.title}" class="listing-image" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Available';">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 truncate">${listing.title}</h3>
                        <p class="text-xl font-bold text-blue-600">$${listing.price.toLocaleString()}/mo</p>
                        <p class="text-gray-600 text-sm">${listing.location}</p>
                        <div class="flex items-center space-x-2 text-sm text-gray-600 mt-2">
                            <span>${listing.bedrooms} Bed</span>
                            <span>•</span>
                            <span>${listing.house_type}</span>
                            <span>•</span>
                            <span>${listing.utilities}</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-2 line-clamp-2">${listing.description || 'No description provided'}</p>
                        <div class="flex space-x-2 mt-4">
                            <button class="view-details-btn w-1/2 bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition" data-listing='${JSON.stringify(listing)}'>View Details</button>
                            <button class="chat-btn w-1/2 bg-green-600 text-white p-2 rounded-lg transition ${hasOwner ? 'hover:bg-green-700' : ''}" data-listing='${JSON.stringify(listing)}' ${hasOwner ? '' : 'disabled title="No owner specified for this listing"'}>Chat</button>
                        </div>
                    </div>
                `;
                container.appendChild(listingCard);
            });

            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const listing = JSON.parse(button.dataset.listing);
                    showListingModal(listing);
                });
            });

            document.querySelectorAll('.chat-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const listing = JSON.parse(button.dataset.listing);
                    startConversation(listing);
                });
            });

            await updateMap(listings);
            console.log('Listings displayed:', listings.length);
        }

        // Modal handling for listings
        const modal = document.getElementById('listingModal');
        const closeButton = document.querySelector('.close-button');

        function showListingModal(listing) {
            document.getElementById('modalTitle').textContent = listing.title;
            document.getElementById('modalPrice').textContent = `$${listing.price.toLocaleString()}/mo`;
            document.getElementById('modalLocation').textContent = listing.location;
            document.getElementById('modalDetails').innerHTML = `
                <span>${listing.bedrooms} Bed</span> • <span>${listing.house_type}</span> • <span>${listing.utilities}</span>
            `;
            document.getElementById('modalDescription').textContent = listing.description || 'No description provided';
            
            const modalImage = document.getElementById('modalImage');
            modalImage.src = listing.media && listing.media.length > 0 && listing.media[0].type.startsWith('image/')
                ? listing.media[0].url
                : 'https://via.placeholder.com/300x200?text=No+Image';
            
            const modalMedia = document.getElementById('modalMedia');
            modalMedia.innerHTML = listing.media && listing.media.length > 0
                ? listing.media.map(file => 
                    file.type.startsWith('image/')
                        ? `<img src="${file.url}" alt="${file.name}">`
                        : `<video src="${file.url}" controls></video>`
                ).join('')
                : '';

            document.getElementById('modalViewDetails').href = `/listing_details?id=${listing.id}`;
            
            modal.style.display = 'block';
            console.log('Modal shown for listing:', listing.title);
        }

        closeButton.addEventListener('click', () => {
            modal.style.display = 'none';
            console.log('Modal closed');
        });

        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
                console.log('Modal closed by clicking outside');
            }
        });

        // Handle form submission
        document.getElementById('listingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Please log in to add a listing.');
                window.location.href = '/login';
                return;
            }

            try {
                const media = uploadedFiles.length > 0 ? await uploadMedia(uploadedFiles) : [];

                const listing = {
                    title: autocorrectInput(sanitizeInput(document.getElementById('title').value)),
                    price: parseInt(document.getElementById('price').value),
                    location: autocorrectInput(sanitizeInput(document.getElementById('location').value)),
                    house_type: document.getElementById('houseType').value,
                    bedrooms: parseInt(document.getElementById('bedrooms').value),
                    utilities: document.getElementById('utilities').value,
                    description: autocorrectInput(sanitizeInput(document.getElementById('description').value)),
                    media: media,
                    user_email: currentUser.email,
                    created_at: new Date().toISOString()
                };

                console.log('Submitting listing:', listing);

                if (!listing.title || !listing.price || !listing.location || !listing.house_type || !listing.bedrooms) {
                    alert('Please fill in all required fields.');
                    return;
                }

                const { data, error } = await supabase
                    .from('listings')
                    .insert([listing])
                    .select();

                if (error) {
                    console.error('Error inserting listing:', error);
                    alert('Failed to add listing: ' + error.message);
                    return;
                }

                const newListing = {
                    ...listing,
                    id: data[0].id,
                    media: media
                };
                currentUser.listings = currentUser.listings || [];
                currentUser.listings.push(newListing);
                let users = JSON.parse(localStorage.getItem('users')) || [];
                users = users.map(u => u.email === currentUser.email ? currentUser : u);
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('Updated localStorage with new listing:', newListing);

                e.target.reset();
                mediaPreview.innerHTML = '';
                uploadedFiles = [];

                alert('Listing added successfully!');
                await displayListings();
            } catch (err) {
                console.error('Submission failed:', err);
                alert('Failed to add listing: ' + (err.message || err));
            }
        });

        // Chat Functionality
        let currentConversationId = null;
        let currentListing = null;

        function setupChat() {
            const chatModal = document.getElementById('chatModal');
            const chatCloseButton = document.querySelector('.chat-close-button');
            const chatMessagesContainer = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');

            if (!chatModal || !chatCloseButton || !chatMessagesContainer || !chatInput || !chatSendBtn) {
                console.error('Chat modal elements missing:', {
                    chatModal: !!chatModal,
                    chatCloseButton: !!chatCloseButton,
                    chatMessagesContainer: !!chatMessagesContainer,
                    chatInput: !!chatInput,
                    chatSendBtn: !!chatSendBtn
                });
                return;
            }

            chatCloseButton.addEventListener('click', () => {
                chatModal.style.display = 'none';
                console.log('Chat modal closed');
            });

            window.addEventListener('click', (event) => {
                if (event.target === chatModal) {
                    chatModal.style.display = 'none';
                    console.log('Chat modal closed by clicking outside');
                }
            });

            chatSendBtn.addEventListener('click', async () => {
                const messageContent = chatInput.value.trim();
                if (!messageContent || !currentConversationId) {
                    console.warn('No message content or conversation ID:', { messageContent, currentConversationId });
                    return;
                }

                console.log('Sending message:', messageContent);
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const { error } = await supabase
                    .from('messages')
                    .insert({
                        conversation_id: currentConversationId,
                        sender_email: currentUser.email,
                        content: messageContent,
                        created_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message: ' + error.message);
                    return;
                }

                chatInput.value = '';
                await loadMessages(currentConversationId);
                console.log('Message sent successfully');
            });

            supabase
                .channel('public:messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                    if (currentConversationId && currentConversationId === payload.new.conversation_id) {
                        console.log('New message received:', payload.new);
                        loadMessages(currentConversationId);
                    }
                })
                .subscribe((status) => {
                    console.log('Supabase channel subscription status:', status);
                });
        }

        async function startConversation(listing) {
            console.log('Starting conversation for listing:', listing.title);
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Please log in to start a chat.');
                window.location.href = '/login';
                return;
            }

            if (!listing.user_email) {
                alert('Cannot start chat: Listing owner not specified.');
                return;
            }

            currentListing = listing;
            document.getElementById('chatTitle').textContent = `Chat about ${listing.title}`;

            const { data: conversations, error } = await supabase
                .from('conversations')
                .select('*')
                .eq('listing_id', listing.id)
                .eq('sender_email', currentUser.email)
                .eq('receiver_email', listing.user_email);

            if (error) {
                console.error('Error checking conversation:', error);
                alert('Failed to load conversation: ' + error.message);
                return;
            }

            let conversation;
            if (conversations && conversations.length > 0) {
                conversation = conversations[0];
                console.log('Existing conversation found:', conversation.id);
            } else {
                const { data, error: insertError } = await supabase
                    .from('conversations')
                    .insert({
                        listing_id: listing.id,
                        sender_email: currentUser.email,
                        receiver_email: listing.user_email,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();

                if (insertError) {
                    console.error('Error creating conversation:', insertError);
                    alert('Failed to start conversation: ' + insertError.message);
                    return;
                }
                conversation = data;
                console.log('New conversation created:', conversation.id);
            }

            currentConversationId = conversation.id;
            await loadMessages(conversation.id);
            document.getElementById('chatModal').style.display = 'block';
            console.log('Chat modal opened for conversation:', conversation.id);
        }

        async function loadMessages(conversationId) {
            console.log('Loading messages for conversation:', conversationId);
            const { data: messages, error } = await supabase
                .from('messages')
                .select('*')
                .eq('conversation_id', conversationId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading messages:', error);
                alert('Failed to load messages: ' + error.message);
                return;
            }

            const chatMessagesContainer = document.getElementById('chatMessages');
            chatMessagesContainer.innerHTML = '';
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sender_email === currentUser.email ? 'sent' : 'received'}`;
                messageElement.innerHTML = `
                    <p>${sanitizeInput(message.content)}</p>
                    <div class="message-timestamp">${new Date(message.created_at).toLocaleTimeString()}</div>
                `;
                chatMessagesContainer.appendChild(messageElement);
            });

            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            console.log('Messages loaded:', messages.length);
        }

        // Real-time subscription to listings
        supabase
            .channel('public:listings')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'listings' }, (payload) => {
                console.log('New listing added:', payload.new);
                displayListings();
            })
            .subscribe();
    </script>
</body>
</html>